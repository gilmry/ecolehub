<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoleHub</title>
    <!-- Fixed: Using production Vue.js build and handling CDN warnings -->
    <script>
        // Suppress Tailwind CDN warning - must be loaded before Tailwind
        (function() {
            if (window.console) {
                const originalWarn = console.warn;
                
                console.warn = function(...args) {
                    const message = args.join(' ');
                    if (message.includes('cdn.tailwindcss.com') || message.includes('should not be used in production')) {
                        return; // Suppress CDN warning
                    }
                    originalWarn.apply(console, args);
                };
            }
        })();
    </script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./i18n.js"></script>
    <style>
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" v-cloak class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-6xl mx-auto px-4 py-6">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">
                            üè´ EcoleHub Stage 4
                        </h1>
                        <p class="text-gray-600 mt-2">{{ $t('app.subtitle') }}</p>
                    </div>
                    
                    <!-- Language Selector -->
                    <div class="flex items-center space-x-2">
                        <label for="language-select" class="text-sm text-gray-700">{{ $t('app.language') }}</label>
                        <select 
                            v-model="currentLanguage" 
                            @change="changeLanguage"
                            id="language-select"
                            aria-label="{{ $t('app.language') }}"
                            class="border rounded px-2 py-1 text-sm"
                        >
                            <option v-for="locale in supportedLocales" :key="locale.code" :value="locale.code">
                                {{ locale.flag }} {{ locale.name }}
                            </option>
                        </select>
                        <button
                          type="button"
                          @click="openConsentSettings"
                          class="ml-2 px-2 py-1 rounded text-sm bg-gray-100 hover:bg-gray-200 text-gray-800"
                          :aria-label="$t('privacy.settings')"
                          :title="$t('privacy.settings')"
                        >
                          üîí {{ $t('privacy.settings') }}
                        </button>
                    </div>
                </div>
                <div v-if="isAuthenticated" class="mt-2 flex justify-between items-center">
                        <span class="text-sm text-green-600">
                        {{ $t('app.connected') }} {{ user.first_name }} {{ user.last_name }}
                    </span>
                    <div v-if="balance" class="text-sm">
                        <span class="font-semibold" :class="balanceColor">
                            üí∞ {{ balance.balance }} unit√©s
                        </span>
                        <span class="text-gray-700 ml-2">{{ $t('sel.acronym') }}</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Banni√®re Demo -->
        <div class="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4">
            <div class="max-w-6xl mx-auto px-4 flex items-center">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-orange-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm">
                            <strong>{{ $t('app.demoVersion') }}</strong> - {{ $t('app.demoDescription') }}
                            <span class="font-medium">{{ $t('app.testAccounts') }}</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <main class="max-w-6xl mx-auto px-4 py-8">
            <!-- Messages -->
            <div v-if="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                {{ errorMessage }}
                <button @click="errorMessage = ''" class="float-right text-red-700 hover:text-red-900" :aria-label="$t('app.close')">√ó</button>
            </div>

            <div v-if="successMessage" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                {{ successMessage }}
                <button @click="successMessage = ''" class="float-right text-green-700 hover:text-green-900" :aria-label="$t('app.close')">√ó</button>
            </div>

            <!-- Login/Register -->
            <div v-if="!isAuthenticated" class="max-w-md mx-auto">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center">
                        {{ isLogin ? 'Connexion' : 'Inscription' }}
                    </h2>
                    
                    <form @submit.prevent="isLogin ? login() : register()">
                        <div class="mb-4">
                            <label for="email" class="block text-gray-700 text-sm font-bold mb-2">{{ $t('auth.email') }}</label>
                            <input
                                v-model="formData.email"
                                type="email"
                                id="email"
                                name="email"
                                aria-label="{{ $t('auth.email') }}"
                                class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                placeholder="votre.email@ecolehub.local"
                            >
                        </div>
                        
                        <div v-if="!isLogin" class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('auth.firstName') }}</label>
                            <input
                                v-model="formData.first_name"
                                type="text"
                                class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                placeholder="Pr√©nom"
                            >
                        </div>
                        
                        <div v-if="!isLogin" class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('auth.lastName') }}</label>
                            <input
                                v-model="formData.last_name"
                                type="text"
                                class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                placeholder="Nom de famille"
                            >
                        </div>
                        
                        <div class="mb-6">
                            <label for="password" class="block text-gray-700 text-sm font-bold mb-2">{{ $t('auth.password') }}</label>
                            <input
                                v-model="formData.password"
                                type="password"
                                id="password"
                                name="password"
                                aria-label="{{ $t('auth.password') }}"
                                class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                minlength="6"
                            >
                        </div>
                        
                        <button
                            type="submit"
                            :disabled="isLoading"
                            class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                        >
                            <span v-if="isLoading">‚è≥ {{ $t('app.loading') }}</span>
                            <span v-else>{{ isLogin ? 'Se connecter' : "S'inscrire" }}</span>
                        </button>
                    </form>
                    
                    <p class="mt-6 text-center text-gray-700">
                        <a href="#" @click.prevent="toggleForm" class="text-blue-700 hover:underline">
                            {{ isLogin ? "Pas encore de compte ? S'inscrire" : "D√©j√† inscrit ? Se connecter" }}
                        </a>
                    </p>
                </div>
            </div>

            <!-- Dashboard Utilisateur Connect√© -->
            <div v-else>
                <!-- Navigation -->
                <nav class="bg-white rounded-lg shadow mb-6">
                    <div class="flex space-x-4 p-4">
                        <button
                            @click="currentTab = 'dashboard'"
                            :class="{'bg-blue-500 text-white': currentTab === 'dashboard', 'text-blue-700': currentTab !== 'dashboard'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üè† {{ $t('navigation.dashboard') }}
                        </button>
                        <button
                            @click="currentTab = 'services'"
                            :class="{'bg-blue-500 text-white': currentTab === 'services', 'text-blue-700': currentTab !== 'services'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üíº {{ $t('navigation.services') }}
                        </button>
                        <button
                            @click="currentTab = 'transactions'"
                            :class="{'bg-blue-500 text-white': currentTab === 'transactions', 'text-blue-700': currentTab !== 'transactions'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üí± {{ $t('navigation.transactions') }}
                        </button>
                        <button
                            @click="currentTab = 'messages'"
                            :class="{'bg-blue-500 text-white': currentTab === 'messages', 'text-blue-700': currentTab !== 'messages'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üí¨ {{ $t('navigation.messages') }}
                        </button>
                        <button
                            @click="currentTab = 'events'"
                            :class="{'bg-blue-500 text-white': currentTab === 'events', 'text-blue-700': currentTab !== 'events'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üìÖ {{ $t('navigation.events') }}
                        </button>
                        <button
                            @click="currentTab = 'shop'"
                            :class="{'bg-blue-500 text-white': currentTab === 'shop', 'text-blue-700': currentTab !== 'shop'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üõí {{ $t('navigation.shop') }}
                        </button>
                        <button
                            @click="currentTab = 'education'"
                            :class="{'bg-blue-500 text-white': currentTab === 'education', 'text-blue-700': currentTab !== 'education'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üìö {{ $t('navigation.education') }}
                        </button>
                        <button
                            @click="currentTab = 'profile'"
                            :class="{'bg-blue-500 text-white': currentTab === 'profile', 'text-blue-700': currentTab !== 'profile'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üë§ {{ $t('navigation.profile') }}
                        </button>
                        <button
                            v-if="user && user.email && (user.email.includes('admin') || user.email.includes('direction'))"
                            @click="currentTab = 'admin'"
                            :class="{'bg-red-500 text-white': currentTab === 'admin', 'text-red-500': currentTab !== 'admin'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            ‚öôÔ∏è {{ $t('navigation.admin') }}
                        </button>
                    </div>
                </nav>

                <!-- Dashboard Tab -->
                <div v-if="currentTab === 'dashboard'">
                    <!-- Balance SEL -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üí∞ {{ $t('sel.myBalance') }}</h2>
                        <div v-if="balance" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <div class="text-3xl font-bold" :class="balanceColor">{{ balance.balance }}</div>
                                <div class="text-gray-600">{{ $t('sel.units') }}</div>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">{{ balance.total_received }}</div>
                                <div class="text-gray-600">{{ $t('transactions.received') }}</div>
                            </div>
                            <div class="text-center p-4 bg-orange-50 rounded-lg">
                                <div class="text-2xl font-bold text-orange-600">{{ balance.total_given }}</div>
                                <div class="text-gray-600">{{ $t('transactions.given') }}</div>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-gray-600">
                            <p>{{ $t('sel.limits') }}</p>
                        </div>
                    </div>

                    <!-- Services Disponibles -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üõçÔ∏è {{ $t('sel.availableServices') }}</h2>
                        <div v-if="availableServices.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="service in availableServices" :key="service.id" 
                                 class="border rounded-lg p-4 hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-semibold">{{ service.title }}</h3>
                                    <span class="text-2xl">{{ getCategoryIcon(service.category) }}</span>
                                </div>
                                <p class="text-gray-600 text-sm mb-3">{{ service.description }}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-600 font-medium">{{ service.units_per_hour }} unit√©s/h</span>
                                    <div class="flex space-x-2">
                                        <button 
                                            @click="requestService(service)"
                                            class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
                                        >
                                            {{ $t('sel.request') }}
                                        </button>
                                        <button 
                                            @click="messageServiceOwner(service)"
                                            class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600"
                                        >
                                            üí¨ {{ $t('messages.send') }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p v-else class="text-gray-500">{{ $t('sel.noServices') }}</p>
                    </div>
                </div>

                <!-- Services Tab -->
                <div v-if="currentTab === 'services'">
                    <!-- Mes Services -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üíº {{ $t('sel.myServices') }}</h2>
                        
                        <!-- Liste mes services -->
                        <div v-if="myServices.length > 0" class="space-y-4 mb-6">
                            <div v-for="service in myServices" :key="service.id" 
                                 class="flex items-center justify-between border rounded-lg p-4">
                                <div class="flex-1">
                                    <h3 class="font-semibold">{{ service.title }}</h3>
                                    <p class="text-gray-600 text-sm">{{ service.description }}</p>
                                    <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mt-2">
                                        {{ getCategoryIcon(service.category) }} {{ service.category }}
                                    </span>
                                </div>
                                <div class="text-right">
                                    <div class="font-medium">{{ service.units_per_hour }} unit√©s/h</div>
                                    <div class="text-sm" :class="service.is_active ? 'text-green-600' : 'text-red-600'">
                                        {{ service.is_active ? 'Actif' : 'Inactif' }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire nouveau service -->
                        <h3 class="text-lg font-semibold mb-4">{{ $t('sel.proposeService') }}</h3>
                        <form @submit.prevent="createService()" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('sel.serviceTitle') }}</label>
                                    <input
                                        v-model="serviceForm.title"
                                        type="text"
                                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                        placeholder="ex: Garde apr√®s √©cole"
                                    >
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('sel.category') }}</label>
                                    <select
                                        v-model="serviceForm.category"
                                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                        @change="onCategoryChange"
                                    >
                                        <option value="">{{ $t('sel.chooseCategory') }}</option>
                                        <option v-for="cat in categories" :key="cat.id" :value="cat.name">
                                            {{ cat.icon }} {{ cat.name }} - {{ cat.description }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Champ pour nouvelle cat√©gorie si "proposition" s√©lectionn√© -->
                            <div v-if="serviceForm.category === 'proposition'" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">
                                    üí≠ Nom de la nouvelle cat√©gorie propos√©e
                                </label>
                                <input
                                    v-model="serviceForm.new_category_name"
                                    type="text"
                                    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="ex: Musique, Sport, Informatique..."
                                    :required="serviceForm.category === 'proposition'"
                                >
                                <div class="text-xs text-yellow-700 mt-1">
                                    Cette proposition sera visible aux autres parents et pourra devenir une nouvelle cat√©gorie officielle.
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('sel.description') }}</label>
                                <textarea
                                    v-model="serviceForm.description"
                                    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    rows="3"
                                    :placeholder="serviceForm.category === 'proposition' ? 'D√©crivez en d√©tail ce nouveau type de service...' : 'D√©crivez votre service...'"
                                ></textarea>
                            </div>
                            <div class="w-full md:w-1/2">
                                <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('sel.unitsPerHour') }}</label>
                                <input
                                    v-model.number="serviceForm.units_per_hour"
                                    type="number"
                                    min="30"
                                    max="120"
                                    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="60"
                                >
                                <div class="text-xs text-gray-500 mt-1">{{ $t('sel.standardRate') }}</div>
                            </div>
                            <button
                                type="submit"
                                :disabled="isLoading"
                                class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 disabled:opacity-50"
                            >
                                Cr√©er le service
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Transactions Tab -->
                <div v-if="currentTab === 'transactions'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">üí± {{ $t('transactions.title') }}</h2>
                        
                        <div v-if="transactions.length > 0" class="space-y-4">
                            <div v-for="transaction in transactions" :key="transaction.id"
                                 class="border rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="font-semibold">
                                            {{ transaction.from_user_id === user.id ? '‚Üí' : '‚Üê' }}
                                            {{ transaction.units }} unit√©s
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            {{ formatDate(transaction.created_at) }}
                                        </div>
                                    </div>
                                    <span class="px-2 py-1 rounded text-xs"
                                          :class="getStatusClass(transaction.status)">
                                        {{ getStatusText(transaction.status) }}
                                    </span>
                                </div>
                                <p v-if="transaction.description" class="text-gray-600 text-sm mb-2">
                                    {{ transaction.description }}
                                </p>
                                
                                <!-- Actions -->
                                <div v-if="transaction.status === 'pending'" class="flex space-x-2 mt-3">
                                    <button v-if="transaction.to_user_id === user.id"
                                            @click="approveTransaction(transaction.id)"
                                            class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                        ‚úÖ Approuver
                                    </button>
                                    <button @click="cancelTransaction(transaction.id)"
                                            class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        ‚ùå Annuler
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p v-else class="text-gray-500">{{ $t('transactions.none') }}</p>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div v-if="currentTab === 'messages'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">üí¨ {{ $t('messages.title') }}</h2>
                            <button 
                                @click="showNewMessageForm = !showNewMessageForm"
                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                            >
                                ‚úâÔ∏è Nouveau message
                            </button>
                        </div>
                        
                        <!-- Formulaire nouveau message direct -->
                        <div v-if="showNewMessageForm" class="bg-gray-50 border rounded-lg p-4 mb-6">
                            <h3 class="font-semibold mb-3">{{ $t('messages.sendDirectMessage') }}</h3>
                            <form @submit.prevent="createDirectMessage()" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('messages.recipient') }}</label>
                                    <select
                                        v-model="newDirectMessage.user_id"
                                        class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    >
                                        <option value="">{{ $t('messages.chooseParent') }}</option>
                                        <option v-for="user in otherUsers" :key="user.id" :value="user.id">
                                            {{ user.name }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('messages.messageLabel') }}</label>
                                    <textarea
                                        v-model="newDirectMessage.content"
                                        class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        rows="3"
                                        placeholder="Votre message..."
                                        required
                                    ></textarea>
                                </div>
                                <div class="flex space-x-2">
                                    <button
                                        type="submit"
                                        :disabled="isLoading"
                                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:opacity-50"
                                    >
                                        Envoyer
                                    </button>
                                    <button
                                        type="button"
                                        @click="showNewMessageForm = false; newDirectMessage = {user_id: '', content: ''}"
                                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                                    >
                                        Annuler
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Liste des conversations -->
                        <div v-if="conversations.length > 0" class="space-y-3 mb-6">
                            <div v-for="conversation in conversations" :key="conversation.id"
                                 @click="openConversation(conversation)"
                                 class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h3 class="font-semibold">{{ conversation.name }}</h3>
                                        <p v-if="conversation.last_message" class="text-gray-600 text-sm mt-1">
                                            {{ conversation.last_message.user_name }}: {{ conversation.last_message.content }}
                                        </p>
                                        <p v-else class="text-gray-500 text-sm mt-1">{{ $t('messages.noMessages') }}</p>
                                    </div>
                                    <div class="text-right text-sm text-gray-500">
                                        <div class="flex items-center space-x-2">
                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                                                {{ getConversationType(conversation.type) }}
                                            </span>
                                            <span v-if="conversation.class_name" class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">
                                                {{ conversation.class_name }}
                                            </span>
                                        </div>
                                        <div v-if="conversation.last_message" class="mt-1">
                                            {{ formatDate(conversation.last_message.created_at) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p v-else class="text-gray-500">{{ $t('messages.noConversations') }}</p>
                        
                        <!-- Messages de la conversation s√©lectionn√©e -->
                        <div v-if="selectedConversation" class="mt-6 border-t pt-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">{{ selectedConversation.name }}</h3>
                                <button 
                                    @click="loadConversationMessages()"
                                    class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600"
                                    title="Actualiser les messages"
                                >
                                    üîÑ Actualiser
                                </button>
                            </div>
                            
                            <!-- Zone de messages -->
                            <div class="h-64 overflow-y-auto border rounded-lg p-4 mb-4 bg-gray-50">
                                <div v-if="conversationMessages.length > 0" class="space-y-3">
                                    <div v-for="message in conversationMessages" :key="message.id"
                                         :class="{'text-right': message.user_id === user.id}"
                                         class="flex"
                                         :class="message.user_id === user.id ? 'justify-end' : 'justify-start'">
                                        <div :class="message.user_id === user.id ? 'bg-blue-500 text-white' : 'bg-white'"
                                             class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg shadow">
                                            <div v-if="message.user_id !== user.id" class="text-xs text-gray-600 mb-1">
                                                {{ message.user_name }}
                                            </div>
                                            <div>{{ message.content }}</div>
                                            <div class="text-xs mt-1" :class="message.user_id === user.id ? 'text-blue-100' : 'text-gray-500'">
                                                {{ formatTime(message.created_at) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p v-else class="text-gray-500 text-center">{{ $t('messages.noMessages') }}</p>
                            </div>
                            
                            <!-- Formulaire nouveau message -->
                            <form @submit.prevent="sendMessage()" class="flex space-x-2">
                                <input
                                    v-model="newMessage"
                                    type="text"
                                    placeholder="Tapez votre message..."
                                    class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    maxlength="500"
                                >
                                <button
                                    type="submit"
                                    :disabled="!newMessage.trim() || isLoading"
                                    class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 disabled:opacity-50"
                                >
                                    Envoyer
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Events Tab -->
                <div v-if="currentTab === 'events'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">üìÖ {{ $t('events.title') }}</h2>
                        
                        <!-- Filtres √©v√©nements -->
                        <div class="mb-6 flex flex-wrap gap-2">
                            <button
                                @click="eventFilter = 'all'"
                                :class="eventFilter === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                Tous
                            </button>
                            <button
                                @click="eventFilter = 'school'"
                                :class="eventFilter === 'school' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                üè´ √âcole
                            </button>
                            <button
                                @click="eventFilter = 'class'"
                                :class="eventFilter === 'class' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                üìö Classes
                            </button>
                            <button
                                @click="eventFilter = 'celebration'"
                                :class="eventFilter === 'celebration' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                üéâ F√™tes
                            </button>
                        </div>
                        
                        <!-- Liste des √©v√©nements -->
                        <div v-if="filteredEvents.length > 0" class="space-y-4">
                            <div v-for="event in filteredEvents" :key="event.id"
                                 class="border rounded-lg p-4 hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold">{{ event.title }}</h3>
                                        <p v-if="event.description" class="text-gray-600 text-sm mt-1">{{ event.description }}</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="px-2 py-1 rounded-full text-xs" :class="getEventTypeClass(event.event_type)">
                                            {{ getEventTypeText(event.event_type) }}
                                        </span>
                                        <div v-if="event.class_name" class="mt-1">
                                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">
                                                {{ event.class_name }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <span class="font-medium">üìÖ {{ $t('events.date') }}:</span>
                                        <div>{{ formatEventDate(event.start_date) }}</div>
                                        <div v-if="event.end_date" class="text-gray-600">
                                            jusqu'√† {{ formatTime(event.end_date) }}
                                        </div>
                                    </div>
                                    <div v-if="event.location">
                                        <span class="font-medium">üìç {{ $t('events.location') }}:</span>
                                        <div>{{ event.location }}</div>
                                    </div>
                                    <div v-if="event.registration_required">
                                        <span class="font-medium">üë• {{ $t('events.participants') }}:</span>
                                        <div>{{ event.participants_count }}{{ event.max_participants ? '/' + event.max_participants : '' }}</div>
                                    </div>
                                </div>
                                
                                <!-- Actions √©v√©nement -->
                                <div v-if="event.registration_required" class="mt-4 flex space-x-2">
                                    <button
                                        v-if="!event.is_registered"
                                        @click="registerForEvent(event.id)"
                                        :disabled="isLoading || (event.max_participants && event.participants_count >= event.max_participants)"
                                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:opacity-50"
                                    >
                                        {{ (event.max_participants && event.participants_count >= event.max_participants) ? 'Complet' : "S'inscrire" }}
                                    </button>
                                    <div v-else class="flex items-center text-green-600">
                                        ‚úÖ Inscrit
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p v-else class="text-gray-500">Aucun √©v√©nement {{ eventFilter === 'all' ? '' : 'dans cette cat√©gorie' }}.</p>
                    </div>
                </div>

                <!-- Shop Tab -->
                <div v-if="currentTab === 'shop'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">üõí {{ $t('shop.title') }}</h2>
                        
                        <!-- Filtres boutique -->
                        <div class="mb-6 flex flex-wrap gap-2">
                            <button
                                @click="shopFilter = 'all'"
                                :class="shopFilter === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                Tous
                            </button>
                            <button
                                @click="shopFilter = 'fournitures'"
                                :class="shopFilter === 'fournitures' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                üìö Fournitures
                            </button>
                            <button
                                @click="shopFilter = 'vetements'"
                                :class="shopFilter === 'vetements' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                üëï V√™tements
                            </button>
                        </div>
                        
                        <!-- Produits boutique -->
                        <div v-if="filteredShopProducts.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div v-for="product in filteredShopProducts" :key="product.product.id" 
                                 class="border rounded-lg p-4 hover:shadow-md transition">
                                <div class="mb-4">
                                    <h3 class="text-lg font-semibold">{{ product.product.name }}</h3>
                                    <p class="text-gray-600 text-sm mt-1">{{ product.product.description }}</p>
                                </div>
                                
                                <!-- Prix et progression -->
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-lg font-bold text-green-600">{{ product.price_breakdown.total_amount }}‚Ç¨</span>
                                        <span class="text-sm text-gray-500">{{ $t('shop.vatIncluded') }}</span>
                                    </div>
                                    
                                    <!-- Barre de progression commande group√©e -->
                                    <div class="w-full bg-gray-200 rounded-full h-3 mb-2">
                                        <div 
                                            class="bg-blue-500 h-3 rounded-full transition-all duration-300"
                                            :style="{ width: product.progress_percentage + '%' }"
                                        ></div>
                                    </div>
                                    
                                    <div class="flex justify-between text-sm">
                                        <span>{{ product.total_interest }}/{{ product.min_quantity }}</span>
                                        <span class="font-medium" :class="product.can_order ? 'text-green-600' : 'text-orange-600'">
                                            {{ product.can_order ? 'Pr√™t √† commander !' : Math.round(product.progress_percentage) + '%' }}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="space-y-2">
                                    <button 
                                        v-if="!product.user_interest.has_interest"
                                        @click="expressInterest(product.product)"
                                        class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600"
                                    >
                                        ‚úã Je suis int√©ress√©(e)
                                    </button>
                                    
                                    <div v-else class="space-y-2">
                                        <div class="text-center text-green-600 font-medium">
                                            ‚úÖ Int√©r√™t exprim√© ({{ product.user_interest.quantity }} pcs)
                                        </div>
                                        <button 
                                            @click="cancelInterest(product.product.id)"
                                            class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600"
                                        >
                                            ‚ùå Annuler int√©r√™t
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Info participants -->
                                <div v-if="product.interested_users_count > 0" class="mt-3 text-sm text-gray-600">
                                    üë• {{ product.interested_users_count }} parent(s) int√©ress√©(s)
                                </div>
                            </div>
                        </div>
                        <p v-else class="text-gray-500">{{ $t('shop.noProducts') }}</p>
                        
                        <!-- Info syst√®me commandes group√©es -->
                        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 class="font-semibold text-blue-800 mb-2">üí° {{ $t('shop.howItWorks') }}</h3>
                            <ol class="text-sm text-blue-700 space-y-1">
                                <li><strong>1.</strong> {{ $t('shop.workflow')[0] }}</li>
                                    <li><strong>2.</strong> {{ $t('shop.workflow')[1] }}</li>
                                    <li><strong>3.</strong> {{ $t('shop.workflow')[2] }}</li>
                                    <li><strong>4.</strong> {{ $t('shop.workflow')[3] }}</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Education Tab -->
                <div v-if="currentTab === 'education'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">üìö {{ $t('education.title') }}</h2>
                        
                        <!-- Coming soon message -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                            <div class="text-6xl mb-4">üìñ</div>
                            <h3 class="text-xl font-semibold text-green-800 mb-2">{{ $t('education.moduleInProgress') }}</h3>
                            <p class="text-green-700 mb-4">
                                Prochainement : Ressources p√©dagogiques, listes de fournitures, 
                                calendrier scolaire et communications √©cole.
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                                <div class="bg-white p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">üìã {{ $t('education.classResources') }}</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>‚Ä¢ {{ $t('education.lists.supplies') }}</li>
                                        <li>‚Ä¢ {{ $t('education.lists.calendar') }}</li>
                                        <li>‚Ä¢ {{ $t('education.lists.forms') }}</li>
                                        <li>‚Ä¢ {{ $t('education.lists.rules') }}</li>
                                    </ul>
                                </div>
                                <div class="bg-white p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">üì¢ {{ $t('education.communications') }}</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>‚Ä¢ {{ $t('education.lists.announcements') }}</li>
                                        <li>‚Ä¢ {{ $t('education.lists.project') }}</li>
                                        <li>‚Ä¢ {{ $t('education.lists.parentMeetings') }}</li>
                                        <li>‚Ä¢ {{ $t('education.lists.specialEvents') }}</li>
                                    </ul>
                                </div>
                            </div>
                            <p class="text-sm text-green-600 mt-4">
                                üìÅ Stockage s√©curis√© avec acc√®s contr√¥l√© par classe
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div v-if="currentTab === 'profile'">
                    <!-- Profil Utilisateur -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üë§ {{ $t('profile.title') }}</h2>
                        <div class="space-y-2">
                            <p><strong>Email:</strong> {{ user.email }}</p>
                            <p><strong>Pr√©nom:</strong> {{ user.first_name }}</p>
                            <p><strong>Nom:</strong> {{ user.last_name }}</p>
                        </div>
                    </div>

                    <!-- Enfants -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üë∂ {{ $t('profile.children') }}</h2>
                        
                        <div v-if="children.length > 0" class="space-y-3 mb-6">
                            <div v-for="child in children" :key="child.id"
                                 class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <div>
                                    <span class="font-semibold">{{ child.first_name }}</span>
                                    <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">
                                        {{ child.class_name }}
                                    </span>
                                </div>
                                <button @click="deleteChild(child.id)" class="text-red-500 hover:text-red-700">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        <form @submit.prevent="addChild()" class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('profile.childName') }}</label>
                                    <input
                                        v-model="childForm.first_name"
                                        type="text"
                                        class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('profile.class') }}</label>
                                    <select
                                        v-model="childForm.class_name"
                                        class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    >
                                        <option value="">{{ $t('profile.chooseClass') }}</option>
                                        <option value="M1">{{ $t('classes.M1') }}</option>
                                        <option value="M2">{{ $t('classes.M2') }}</option>
                                        <option value="M3">{{ $t('classes.M3') }}</option>
                                        <option value="P1">{{ $t('classes.P1') }}</option>
                                        <option value="P2">{{ $t('classes.P2') }}</option>
                                        <option value="P3">{{ $t('classes.P3') }}</option>
                                        <option value="P4">{{ $t('classes.P4') }}</option>
                                        <option value="P5">{{ $t('classes.P5') }}</option>
                                        <option value="P6">{{ $t('classes.P6') }}</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                {{ $t('profile.addChild') }}
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Info Stage 2 -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-2">üöÄ {{ $t('app.demo.stage2Title') }}</h3>
                    <p class="text-blue-700">
                        {{ $t('app.demo.newFeatures') }}
                        <br>
                        <strong>{{ $t('app.demo.nextStepLabel') }}</strong> {{ $t('app.demo.nextStepValue') }}
                    </p>
                </div>

                <!-- Admin Tab -->
                <div v-if="currentTab === 'admin'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è {{ $t('admin.title') }}</h2>
                        
                        <!-- Navigation Admin -->
                        <div class="mb-6 flex space-x-4">
                            <button
                                @click="adminSection = 'products'"
                                :class="adminSection === 'products' ? 'bg-red-500 text-white' : 'bg-gray-200'"
                                class="px-4 py-2 rounded font-medium"
                            >
                                üì¶ {{ $t('admin.products') }}
                            </button>
                            <button
                                @click="adminSection = 'interests'"
                                :class="adminSection === 'interests' ? 'bg-red-500 text-white' : 'bg-gray-200'"
                                class="px-4 py-2 rounded font-medium"
                            >
                                üë• {{ $t('admin.interests') }}
                            </button>
                            <button
                                @click="adminSection = 'orders'"
                                :class="adminSection === 'orders' ? 'bg-red-500 text-white' : 'bg-gray-200'"
                                class="px-4 py-2 rounded font-medium"
                            >
                                üöÄ {{ $t('admin.orders') }}
                            </button>
                            <button
                                @click="adminSection = 'stats'"
                                :class="adminSection === 'stats' ? 'bg-red-500 text-white' : 'bg-gray-200'"
                                class="px-4 py-2 rounded font-medium"
                            >
                                üìä {{ $t('admin.statistics') }}
                            </button>
                        </div>

                        <!-- Section Gestion Produits -->
                        <div v-if="adminSection === 'products'">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">üì¶ {{ $t('admin.productManagement') }}</h3>
                                <button 
                                    @click="showProductForm = !showProductForm"
                                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                >
                                    ‚ûï {{ $t('admin.newProduct') }}
                                </button>
                            </div>
                            
                            <!-- Formulaire cr√©ation produit -->
                            <div v-if="showProductForm" class="bg-gray-50 border rounded-lg p-4 mb-6">
                                <h4 class="font-semibold mb-3">{{ $t('admin.newProduct') }}</h4>
                                <form @submit.prevent="createProduct()" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('admin.productName') }}</label>
                                            <input
                                                v-model="newProduct.name"
                                                type="text"
                                                class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                required
                                                :placeholder="$t('admin.productNamePlaceholder')"
                                            >
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('admin.category') }}</label>
                                            <select
                                                v-model="newProduct.category"
                                                class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                required
                                            >
                                                <option value="">{{ $t('admin.chooseCategory') }}</option>
                                                <option value="fournitures">üìö {{ $t('shop.categories.fournitures') }}</option>
                                                <option value="vetements">üëï {{ $t('shop.categories.vetements') }}</option>
                                                <option value="accessoires">üéí {{ $t('shop.categories.accessoires') }}</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('shop.description') }}</label>
                                        <textarea
                                            v-model="newProduct.description"
                                            class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            rows="3"
                                            :placeholder="$t('admin.productDescriptionPlaceholder')"
                                        ></textarea>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                        <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('admin.priceEUR') }}</label>
                                            <input
                                                v-model.number="newProduct.base_price"
                                                type="number"
                                                step="0.01"
                                                min="0"
                                                class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                required
                                                placeholder="12.50"
                                            >
                                        </div>
                                        <div>
                                        <label class="block text-gray-700 text-sm font-bold mb-2">{{ $t('shop.minimumQuantity') }}</label>
                                            <input
                                                v-model.number="newProduct.min_quantity"
                                                type="number"
                                                min="1"
                                                class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                required
                                                placeholder="10"
                                            >
                                        </div>
                                        <div class="flex items-end">
                                            <button
                                                type="submit"
                                                :disabled="isLoading"
                                                class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 disabled:opacity-50"
                                            >
                                                Cr√©er Produit
                                            </button>
                                        </div>
                                    </div>
                                    <button
                                        type="button"
                                        @click="showProductForm = false; resetProductForm()"
                                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                                    >
                                        Annuler
                                    </button>
                                </form>
                            </div>
                            
                            <!-- Liste produits admin -->
                            <div v-if="shopProducts.length > 0" class="space-y-4">
                                <div v-for="product in shopProducts" :key="product.product.id" 
                                     class="border rounded-lg p-4 bg-gray-50">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex-1">
                                            <h4 class="font-semibold">{{ product.product.name }}</h4>
                                            <p class="text-gray-600 text-sm">{{ product.product.description }}</p>
                                            <div class="flex items-center space-x-4 mt-2 text-sm">
                                                <span class="font-medium">{{ product.price_breakdown.total_amount }}‚Ç¨</span>
                                                <span class="text-gray-500">{{ product.product.category }}</span>
                                                <span class="text-gray-500">Min: {{ product.product.min_quantity }}</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold" :class="product.can_order ? 'text-green-600' : 'text-orange-600'">
                                                {{ product.total_interest }}/{{ product.min_quantity }}
                                            </div>
                                            <div class="text-sm text-gray-500">{{ Math.round(product.progress_percentage) }}%</div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex space-x-2">
                                        <button
                                            v-if="product.can_order"
                                            @click="createGroupOrder(product.product.id)"
                                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
                                        >
                                            üöÄ Lancer Commande Group√©e
                                        </button>
                                        <button
                                            @click="toggleProductActive(product.product)"
                                            :class="product.product.is_active ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'"
                                            class="text-white px-3 py-2 rounded"
                                        >
                                            {{ product.product.is_active ? '‚è∏Ô∏è D√©sactiver' : '‚ñ∂Ô∏è Activer' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section Int√©r√™ts -->
                        <div v-if="adminSection === 'interests'">
                            <h3 class="text-lg font-semibold mb-4">üë• {{ $t('admin.parentsInterestsView') }}</h3>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                <div class="text-4xl mb-2">üîÑ</div>
                                <p class="text-blue-700">
                                    Interface de gestion des int√©r√™ts en d√©veloppement.<br>
                                    Prochainement : Vue d√©taill√©e par parent et par produit.
                                </p>
                            </div>
                        </div>

                        <!-- Section Commandes -->
                        <div v-if="adminSection === 'orders'">
                            <h3 class="text-lg font-semibold mb-4">üöÄ {{ $t('admin.orders') }}</h3>
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                <div class="text-4xl mb-2">üìã</div>
                                <p class="text-green-700">
                                    Interface de gestion des commandes en d√©veloppement.<br>
                                    Prochainement : Suivi Mollie, status livraisons, relances parents.
                                </p>
                            </div>
                        </div>

                        <!-- Section Statistiques -->
                        <div v-if="adminSection === 'stats'">
                            <h3 class="text-lg font-semibold mb-4">üìä {{ $t('admin.statistics') }}</h3>
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                                <div class="text-4xl mb-2">üìà</div>
                                <p class="text-purple-700">
                                    Tableau de bord statistiques en d√©veloppement.<br>
                                    Prochainement : CA, produits populaires, taux conversion.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mentions l√©gales -->
                <div v-if="currentTab === 'legal'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-6">‚öñÔ∏è {{ $t('legal.mentions') }}</h2>

                        <div class="prose max-w-none">
                            <h3 class="text-lg font-semibold mb-3">{{ $t('legal.sitePublisherTitle') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p><strong>{{ $t('legal.publisherName') }}</strong></p>
                                <p>{{ $t('legal.publisherAddress') }}</p>
                                <p>{{ $t('legal.emailLabel') }} <a href="mailto:gilmry+ecolehub@gmail.com" class="text-blue-600">{{ $t('legal.contactEmailText') }}</a></p>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('legal.publicationManagerTitle') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p>{{ $t('legal.techManager') }}</p>
                                <p>{{ $t('legal.emailLabel') }} <a href="mailto:gilmry+ecolehub@gmail.com" class="text-blue-600">{{ $t('legal.contactEmailText') }}</a></p>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('legal.hostingTitle') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p>{{ $t('legal.hostingProvider') }}</p>
                                <p>{{ $t('legal.hostingAddress') }}</p>
                                <p>{{ $t('legal.serversInEurope') }}</p>
                                <p>{{ $t('legal.complianceNote') }}</p>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('legal.intellectualPropertyTitle') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p>{{ $t('legal.ipParagraph1') }}</p>
                                <p>{{ $t('legal.ipParagraph2') }}</p>
                                <p>{{ $t('legal.ipParagraph3') }}</p>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('legal.responsibilityTitle') }}</h3>
                            <div class="text-gray-700">
                                <p>{{ $t('legal.responsibilityP1') }}</p>
                                <p>{{ $t('legal.responsibilityP2') }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Politique de confidentialit√© -->
                <div v-if="currentTab === 'privacy'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-6">üîí {{ $t('privacy.title') }}</h2>

                        <div class="prose max-w-none">
                            <h3 class="text-lg font-semibold mb-3">{{ $t('privacy.collectionTitle') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p>{{ $t('privacy.collectionIntro') }}</p>
                                <ul class="list-disc ml-6 mt-2">
                                    <li>{{ $t('privacy.collection.items.parentsIdentity') }}</li>
                                    <li>{{ $t('privacy.collection.items.childrenClass') }}</li>
                                    <li>{{ $t('privacy.collection.items.selTransactions') }}</li>
                                    <li>{{ $t('privacy.collection.items.messages') }}</li>
                                </ul>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('privacy.useTitle') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p>{{ $t('privacy.useIntro') }}</p>
                                <ul class="list-disc ml-6 mt-2">
                                    <li>{{ $t('privacy.use.items.communication') }}</li>
                                    <li>{{ $t('privacy.use.items.sel') }}</li>
                                    <li>{{ $t('privacy.use.items.events') }}</li>
                                    <li>{{ $t('privacy.use.items.shop') }}</li>
                                </ul>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('privacy.shareTitle') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p>{{ $t('privacy.shareP1') }}</p>
                                <p>{{ $t('privacy.shareP2') }}</p>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('privacy.securityTitle') }}</h3>
                            <div class="text-gray-700">
                                <p>{{ $t('privacy.securityIntro') }}</p>
                                <ul class="list-disc ml-6 mt-2">
                                    <li>{{ $t('privacy.security.items.encryption') }}</li>
                                    <li>{{ $t('privacy.security.items.passwords') }}</li>
                                    <li>{{ $t('privacy.security.items.backups') }}</li>
                                    <li>{{ $t('privacy.security.items.serversBE') }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Protection des donn√©es RGPD -->
                <div v-if="currentTab === 'rgpd'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-6">üõ°Ô∏è {{ $t('rgpd.title') }}</h2>

                        <div class="prose max-w-none">
                            <h3 class="text-lg font-semibold mb-3">{{ $t('rgpd.rightsTitle') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p>{{ $t('rgpd.rightsIntro') }}</p>
                                <ul class="list-disc ml-6 mt-2">
                                    <li>{{ $t('rgpd.rights.access') }}</li>
                                    <li>{{ $t('rgpd.rights.rectification') }}</li>
                                    <li>{{ $t('rgpd.rights.erasure') }}</li>
                                    <li>{{ $t('rgpd.rights.portability') }}</li>
                                    <li>{{ $t('rgpd.rights.objection') }}</li>
                                </ul>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('rgpd.legalBasisTitle') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p>{{ $t('rgpd.legalBasisIntro') }}</p>
                                <ul class="list-disc ml-6 mt-2">
                                    <li>{{ $t('rgpd.legalBasis.consent') }}</li>
                                    <li>{{ $t('rgpd.legalBasis.legitimateInterest') }}</li>
                                    <li>{{ $t('rgpd.legalBasis.contract') }}</li>
                                </ul>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('rgpd.retentionTitle') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p>{{ $t('rgpd.retentionIntro') }}</p>
                                <ul class="list-disc ml-6 mt-2">
                                    <li>{{ $t('rgpd.retention.schooling') }}</li>
                                    <li>{{ $t('rgpd.retention.twoYears') }}</li>
                                    <li>{{ $t('rgpd.retention.earlyDeletion') }}</li>
                                </ul>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('dpo.title') }}</h3>
                            <div class="mb-6 text-gray-700">
                                <p>{{ $t('dpo.contactIntro') }}</p>
                                <p><strong>{{ $t('dpo.nameLabel') }}</strong></p>
                                <p>{{ $t('dpo.emailLabel') }} <a href="mailto:gilmry+ecolehub@gmail.com" class="text-blue-600">gilmry+ecolehub@gmail.com</a></p>
                                <p>{{ $t('dpo.address') }}</p>
                            </div>

                            <h3 class="text-lg font-semibold mb-3">{{ $t('complaint.title') }}</h3>
                            <div class="text-gray-700">
                                <p>{{ $t('complaint.intro') }}</p>
                                <p><strong>{{ $t('complaint.authorityName') }}</strong></p>
                                <p>{{ $t('complaint.websiteLabel') }} <a href="https://www.autoriteprotectiondonnees.be" class="text-blue-600" target="_blank">www.autoriteprotectiondonnees.be</a></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- D√©connexion -->
                <div v-if="isAuthenticated" class="text-center">
                    <button @click="logout()" class="bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600">
                        Se d√©connecter
                    </button>
                </div>
            </div>
        </main>

        <!-- Footer avec mentions l√©gales -->
        <footer class="bg-gray-800 text-white mt-16">
            <div class="max-w-6xl mx-auto px-4 py-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- √Ä propos -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">üè´ {{ $t('footer.brand') }}</h3>
                        <p class="text-gray-300 text-sm">
                            {{ $t('footer.aboutP1') }}
                            {{ $t('footer.aboutP2') }}
                        </p>
                    </div>

                    <!-- Contact -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">{{ $t('footer.contactTitle') }}</h3>
                        <p class="text-gray-300 text-sm">
                            {{ $t('footer.companyName') }}<br>
                            {{ $t('footer.companyAddress') }}<br>
                            <a href="mailto:gilmry+ecolehub@gmail.com" class="text-blue-400 hover:text-blue-300">{{ $t('footer.emailLinkText') }}</a>
                        </p>
                    </div>

                    <!-- Mentions l√©gales -->
                    <div>
                        <h3 class="text-lg font-semibold mb-4">{{ $t('footer.legalTitle') }}</h3>
                        <ul class="text-gray-300 text-sm space-y-2">
                            <li><a href="#" @click="currentTab = 'legal'" class="hover:text-blue-300">{{ $t('legal.mentions') }}</a></li>
                            <li><a href="#" @click="currentTab = 'privacy'" class="hover:text-blue-300">{{ $t('legal.privacy') }}</a></li>
                            <li><a href="#" @click="currentTab = 'rgpd'" class="hover:text-blue-300">{{ $t('legal.dataProtection') }}</a></li>
                            <li><button type="button" @click="openConsentSettings" class="hover:text-blue-300 underline">Pr√©f√©rences de confidentialit√©</button></li>
                        </ul>
                    </div>
                </div>

                <div class="border-t border-gray-700 mt-8 pt-8 text-center">
                    <p class="text-gray-400 text-sm">
                        {{ $t('footer.copyright') }} -
                        <span class="text-xs">{{ $t('app.demo.footer') }}</span>
                    </p>
                    <p class="text-gray-200 text-xs mt-2">
                        {{ $t('footer.gdprCompliant') }}
                    </p>
                </div>
            </div>
        </footer>

        <!-- Consent Banner -->
        <div v-if="showConsentBanner" class="fixed inset-x-0 bottom-0 bg-white border-t shadow-md" role="dialog" aria-labelledby="consent-title">
          <div class="max-w-6xl mx-auto p-4">
            <h2 id="consent-title" class="text-lg font-semibold mb-2">{{ $t('privacy.bannerTitle') }}</h2>
            <p class="text-sm text-gray-700 mb-3">{{ $t('privacy.bannerDescription') }}</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
              <label class="flex items-start space-x-2">
                <input type="checkbox" v-model="consentPrefs.consent_analytics_platform" :aria-label="$t('privacy.analytics')" class="mt-1" />
                <span>{{ $t('privacy.analytics') }}</span>
              </label>
              <label class="flex items-start space-x-2">
                <input type="checkbox" v-model="consentPrefs.consent_comms_newsletter" :aria-label="$t('privacy.newsletter')" class="mt-1" />
                <span>{{ $t('privacy.newsletter') }}</span>
              </label>
              <label class="flex items-start space-x-2">
                <input type="checkbox" v-model="consentPrefs.consent_comms_shop_marketing" :aria-label="$t('privacy.shopMarketing')" class="mt-1" />
                <span>{{ $t('privacy.shopMarketing') }}</span>
              </label>
              <label class="flex items-start space-x-2">
                <input type="checkbox" v-model="consentPrefs.consent_cookies_preference" :aria-label="$t('privacy.cookiesPreference')" class="mt-1" />
                <span>{{ $t('privacy.cookiesPreference') }}</span>
              </label>
              <label class="flex items-start space-x-2">
                <input type="checkbox" v-model="consentPrefs.consent_photos_publication" :aria-label="$t('privacy.photosPublication')" class="mt-1" />
                <span>{{ $t('privacy.photosPublication') }}</span>
              </label>
              <label class="flex items-start space-x-2">
                <input type="checkbox" v-model="consentPrefs.consent_data_share_thirdparties" :aria-label="$t('privacy.dataShareThirdparties')" class="mt-1" />
                <span>{{ $t('privacy.dataShareThirdparties') }}</span>
              </label>
            </div>
            <div class="flex flex-wrap gap-2 justify-end">
              <button @click="rejectNonEssential" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">{{ $t('privacy.rejectNonEssential') }}</button>
              <button @click="saveConsentPrefs" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">{{ $t('common.save') }}</button>
              <button @click="acceptAll" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">{{ $t('privacy.acceptAll') }}</button>
            </div>
          </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        const app = createApp({
            data() {
                return {
                    // √âtat global
                    isLoading: false,
                    errorMessage: '',
                    successMessage: '',
                    currentTab: 'dashboard',
                    
                    // Auth
                    isLogin: true,
                    isAuthenticated: false,
                    user: null,
                    
                    // Forms
                    formData: { email: '', first_name: '', last_name: '', password: '' },
                    childForm: { first_name: '', class_name: '' },
                    serviceForm: { title: '', description: '', category: '', units_per_hour: 60, new_category_name: '' },
                    
                    // SEL Data
                    balance: null,
                    categories: [
                        { id: 1, name: 'Education', icon: 'üìö', description: 'Aide aux devoirs, soutien scolaire' },
                        { id: 2, name: 'Garde', icon: 'üë∂', description: 'Garde d\'enfants, babysitting' },
                        { id: 3, name: 'Transport', icon: 'üöó', description: 'Covoiturage, transport scolaire' },
                        { id: 4, name: 'Cuisine', icon: 'üç≥', description: 'Pr√©paration repas, cours cuisine' },
                        { id: 5, name: 'Jardinage', icon: 'üå±', description: 'Jardinage, bricolage ext√©rieur' },
                        { id: 6, name: 'Informatique', icon: 'üíª', description: 'Aide informatique, r√©parations' },
                        { id: 7, name: 'Artisanat', icon: 'üé®', description: 'Cr√©ations manuelles, arts' },
                        { id: 8, name: 'Sport', icon: '‚öΩ', description: 'Activit√©s sportives, coaching' },
                        { id: 9, name: 'Musique', icon: 'üéµ', description: 'Cours de musique, instruments' },
                        { id: 10, name: 'proposition', icon: 'üí≠', description: 'Proposer une nouvelle cat√©gorie' }
                    ],
                    myServices: [],
                    availableServices: [],
                    transactions: [],
                    children: [],
                    
                    // Stage 2: Messaging Data
                    conversations: [],
                    selectedConversation: null,
                    conversationMessages: [],
                    newMessage: '',
                    showNewMessageForm: false,
                    newDirectMessage: { user_id: '', content: '' },
                    otherUsers: [],
                    messagePolling: null,
                    
                    // Stage 2: Events Data
                    events: [],
                    eventFilter: 'all',
                    
                    // Stage 3: Shop Data
                    shopProducts: [],
                    shopFilter: 'all',
                    
                    // Stage 3: Education Data
                    educationResources: [],
                    educationFilter: 'all',
                    
                    // Admin Data
                    adminSection: 'products',
                    showProductForm: false,
                    newProduct: {
                        name: '',
                        description: '',
                        category: '',
                        base_price: 0,
                        min_quantity: 10
                    },
                    
                    // Stage 4: Multilingual Data
                    currentLanguage: 'fr-BE',
                    supportedLocales: window.EcoleHubI18n.getSupportedLocales()
                    
                    // Consent
                    showConsentBanner: false,
                    consentPrefs: {
                      consent_analytics_platform: false,
                      consent_comms_operational: true,
                      consent_comms_newsletter: false,
                      consent_comms_shop_marketing: false,
                      consent_cookies_preference: false,
                      consent_photos_publication: false,
                      consent_data_share_thirdparties: false,
                    }
                }
            },
            
            computed: {
                balanceColor() {
                    if (!this.balance) return 'text-gray-600';
                    if (this.balance.balance < 0) return 'text-red-600';
                    if (this.balance.balance > 300) return 'text-green-600';
                    return 'text-blue-600';
                },
                
                filteredEvents() {
                    if (this.eventFilter === 'all') return this.events;
                    return this.events.filter(event => event.event_type === this.eventFilter);
                },
                
                filteredShopProducts() {
                    if (this.shopFilter === 'all') return this.shopProducts;
                    return this.shopProducts.filter(product => product.product.category === this.shopFilter);
                }
            },
            
            async mounted() {
                // Initialize i18n system first
                try {
                    await window.EcoleHubI18n.initializeFromStorage();
                    this.currentLanguage = window.EcoleHubI18n.getCurrentLocale();
                    this.$forceUpdate(); // Re-render with translations
                } catch (error) {
                    console.warn('i18n initialization failed, using fallback');
                }
                
                const token = localStorage.getItem('token');
                if (token) {
                    await this.loadUserData(token);
                }
                await this.loadCategories();
                // Consent: load local and optionally fetch from server
                this.loadConsentLocal();
                if (this.isAuthenticated) { await this.fetchConsentServer(); }
                if (!localStorage.getItem('consent_prefs_set')) {
                  this.showConsentBanner = true;
                }
                
                // Events will be loaded after authentication
            },
            
            methods: {
                // Consent methods
                loadConsentLocal() {
                  try {
                    const raw = localStorage.getItem('consent_prefs');
                    if (raw) {
                      const prefs = JSON.parse(raw);
                      this.consentPrefs = { ...this.consentPrefs, ...prefs };
                    }
                  } catch (e) {}
                },
                saveConsentLocal() {
                  localStorage.setItem('consent_prefs', JSON.stringify(this.consentPrefs));
                  localStorage.setItem('consent_prefs_set', '1');
                },
                async fetchConsentServer() {
                  try {
                    const token = localStorage.getItem('token');
                    if (!token) return;
                    const resp = await fetch('/api/consent/preferences', { headers: { 'Authorization': `Bearer ${token}` } });
                    if (resp.ok) {
                      const serverPrefs = await resp.json();
                      this.consentPrefs = { ...this.consentPrefs, ...serverPrefs };
                    }
                  } catch (e) { console.warn('Consent fetch failed'); }
                },
                async updateConsentServer() {
                  try {
                    const token = localStorage.getItem('token');
                    if (!token) return;
                    await fetch('/api/consent/preferences', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                      body: JSON.stringify(this.consentPrefs)
                    });
                  } catch (e) { console.warn('Consent update failed'); }
                },
                async acceptAll() {
                  Object.keys(this.consentPrefs).forEach(k => { this.consentPrefs[k] = true; });
                  this.consentPrefs.consent_comms_operational = true;
                  this.saveConsentLocal();
                  await this.updateConsentServer();
                  this.showConsentBanner = false;
                },
                async rejectNonEssential() {
                  const keep = ['consent_comms_operational'];
                  Object.keys(this.consentPrefs).forEach(k => { this.consentPrefs[k] = keep.includes(k); });
                  this.saveConsentLocal();
                  await this.updateConsentServer();
                  this.showConsentBanner = false;
                },
                async saveConsentPrefs() {
                  this.saveConsentLocal();
                  await this.updateConsentServer();
                  this.showConsentBanner = false;
                },
                openConsentSettings() { this.showConsentBanner = true; },
                async loadUserData(token) {
                    try {
                        const userResponse = await fetch('/api/me', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (userResponse.ok) {
                            this.user = await userResponse.json();
                            this.isAuthenticated = true;
                            await this.loadAllData();
                        } else {
                            localStorage.removeItem('token');
                        }
                    } catch (error) {
                        console.error('Erreur chargement utilisateur:', error);
                        localStorage.removeItem('token');
                    }
                },
                
                async loadAllData() {
                    await Promise.all([
                        this.loadBalance(),
                        this.loadChildren(),
                        this.loadMyServices(),
                        this.loadAvailableServices(),
                        this.loadTransactions(),
                        this.loadConversations(),
                        this.loadOtherUsers(),
                        this.loadShopProducts(),
                        this.loadEducationResources()
                    ]);
                    
                    // Load events after other data
                    await this.loadEvents();
                },
                
                async loadBalance() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/sel/balance', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.balance = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur balance:', error);
                    }
                },
                
                async loadCategories() {
                    try {
                        const response = await fetch('/api/sel/categories');
                        if (response.ok) {
                            const serverCategories = await response.json();
                            // Merge server categories with default ones if server has data
                            if (Array.isArray(serverCategories) && serverCategories.length > 0) {
                                this.categories = serverCategories;
                            }
                            // Default categories are already loaded in data
                        } else {
                            console.warn('Categories endpoint returned:', response.status);
                            // Keep default categories
                        }
                    } catch (error) {
                        console.error('Erreur cat√©gories:', error);
                        // Keep default categories
                    }
                },
                
                async loadMyServices() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/sel/services/mine', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.myServices = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur services:', error);
                    }
                },
                
                async loadAvailableServices() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/sel/services', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.availableServices = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur services disponibles:', error);
                    }
                },
                
                async loadTransactions() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/sel/transactions', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.transactions = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur transactions:', error);
                    }
                },
                
                async loadChildren() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/children', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.children = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur enfants:', error);
                    }
                },
                
                async register() {
                    this.isLoading = true;
                    this.errorMessage = '';
                    
                    try {
                        const response = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.formData)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            localStorage.setItem('token', data.access_token);
                            await this.loadUserData(data.access_token);
                            this.successMessage = 'Inscription r√©ussie ! Balance SEL: 120 unit√©s cr√©√©e.';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur inscription';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion au serveur';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async login() {
                    this.isLoading = true;
                    this.errorMessage = '';
                    
                    try {
                        const formData = new FormData();
                        formData.append('email', this.formData.email);
                        formData.append('password', this.formData.password);
                        
                        const response = await fetch('/api/login', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            localStorage.setItem('token', data.access_token);
                            await this.loadUserData(data.access_token);
                            this.successMessage = 'Connexion r√©ussie !';
                        } else {
                            this.errorMessage = 'Email ou mot de passe incorrect';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion au serveur';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async createService() {
                    this.isLoading = true;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/sel/services', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(this.serviceForm)
                        });
                        
                        if (response.ok) {
                            await this.loadMyServices();
                            await this.loadAvailableServices();
                            this.serviceForm = { title: '', description: '', category: '', units_per_hour: 60, new_category_name: '' };
                            const message = this.serviceForm.category === 'proposition' 
                                ? 'Proposition de service cr√©√©e ! Elle sera visible aux autres parents.'
                                : 'Service cr√©√© avec succ√®s !';
                            this.successMessage = message;
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur cr√©ation service';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async addChild() {
                    this.isLoading = true;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/children', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(this.childForm)
                        });
                        
                        if (response.ok) {
                            await this.loadChildren();
                            this.childForm = { first_name: '', class_name: '' };
                            this.successMessage = 'Enfant ajout√© !';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur ajout enfant';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async deleteChild(childId) {
                    if (!confirm('Supprimer cet enfant ?')) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/children/${childId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            await this.loadChildren();
                            this.successMessage = 'Enfant supprim√©';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur suppression';
                    }
                },
                
                onCategoryChange() {
                    // Reset new category name if not proposition
                    if (this.serviceForm.category !== 'proposition') {
                        this.serviceForm.new_category_name = '';
                    }
                },
                
                getCategoryIcon(category) {
                    const cat = this.categories.find(c => c.name === category);
                    return cat ? cat.icon : 'üí°';
                },
                
                getStatusClass(status) {
                    const classes = {
                        pending: 'bg-yellow-100 text-yellow-800',
                        approved: 'bg-green-100 text-green-800',
                        completed: 'bg-blue-100 text-blue-800',
                        cancelled: 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },
                
                getStatusText(status) {
                    const texts = {
                        pending: 'En attente',
                        approved: 'Approuv√©e', 
                        completed: 'Termin√©e',
                        cancelled: 'Annul√©e'
                    };
                    return texts[status] || status;
                },
                
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleString('fr-BE');
                },
                
                toggleForm() {
                    this.isLogin = !this.isLogin;
                    this.formData = { email: '', first_name: '', last_name: '', password: '' };
                    this.errorMessage = '';
                },
                
                async requestService(service) {
                    // Demander un service √† un autre parent
                    const units = prompt(`Combien d'unit√©s demander pour "${service.title}" ?\n(${service.units_per_hour} unit√©s/heure)`);
                    if (!units || isNaN(units) || units <= 0) return;
                    
                    const description = prompt('Description de votre demande:');
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/sel/transactions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                to_user_id: service.user_id,
                                service_id: service.id,
                                units: parseInt(units),
                                description: description
                            })
                        });
                        
                        if (response.ok) {
                            await this.loadTransactions();
                            await this.loadBalance();
                            this.successMessage = 'Demande de service cr√©√©e ! En attente d\'approbation.';
                            this.currentTab = 'transactions';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur cr√©ation demande';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                async approveTransaction(transactionId) {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/sel/transactions/${transactionId}/approve`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            await this.loadTransactions();
                            await this.loadBalance();
                            this.successMessage = 'Transaction approuv√©e ! Balances mises √† jour.';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur approbation';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                async cancelTransaction(transactionId) {
                    if (!confirm('Annuler cette transaction ?')) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/sel/transactions/${transactionId}/cancel`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            await this.loadTransactions();
                            this.successMessage = 'Transaction annul√©e.';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur annulation';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                async loadConversations() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/conversations', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.conversations = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur conversations:', error);
                    }
                },
                
                async loadEvents() {
                    try {
                        const token = localStorage.getItem('token');
                        console.log('üîç Loading events with token:', token ? 'EXISTS' : 'MISSING');
                        
                        const response = await fetch('/api/events', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        console.log('üîç Events API response status:', response.status);
                        
                        if (response.ok) {
                            const eventsData = await response.json();
                            this.events = eventsData;
                            console.log('üìÖ √âv√©nements charg√©s:', this.events.length, 'Donn√©es:', eventsData);
                        } else {
                            const errorData = await response.text();
                            console.error('‚ùå Erreur API events:', response.status, errorData);
                        }
                    } catch (error) {
                        console.error('Erreur √©v√©nements:', error);
                    }
                },
                
                async openConversation(conversation) {
                    this.selectedConversation = conversation;
                    await this.loadConversationMessages();
                    
                    // Start polling for new messages every 3 seconds
                    this.startMessagePolling();
                },
                
                async loadConversationMessages() {
                    if (!this.selectedConversation) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/conversations/${this.selectedConversation.id}/messages`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.conversationMessages = await response.json();
                            
                            // Auto-scroll to bottom
                            this.$nextTick(() => {
                                const messagesDiv = document.querySelector('.overflow-y-auto');
                                if (messagesDiv) {
                                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Erreur messages:', error);
                    }
                },
                
                startMessagePolling() {
                    // Clear existing polling
                    if (this.messagePolling) {
                        clearInterval(this.messagePolling);
                    }
                    
                    // Start new polling every 3 seconds
                    this.messagePolling = setInterval(() => {
                        if (this.selectedConversation && this.currentTab === 'messages') {
                            this.loadConversationMessages();
                        }
                    }, 3000);
                },
                
                stopMessagePolling() {
                    if (this.messagePolling) {
                        clearInterval(this.messagePolling);
                        this.messagePolling = null;
                    }
                },
                
                async sendMessage() {
                    if (!this.selectedConversation || !this.newMessage.trim()) return;
                    
                    // TODO: Implement WebSocket message sending
                    // For now, use HTTP API
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/conversations/${this.selectedConversation.id}/messages`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                content: this.newMessage
                            })
                        });
                        
                        if (response.ok) {
                            this.newMessage = '';
                            await this.loadConversationMessages();
                        }
                    } catch (error) {
                        console.error('Erreur envoi message:', error);
                    }
                },
                
                async registerForEvent(eventId) {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/events/${eventId}/register`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            await this.loadEvents();
                            this.successMessage = 'Inscription √† l\'√©v√©nement confirm√©e !';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur inscription √©v√©nement';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                getConversationType(type) {
                    const types = {
                        direct: 'Direct',
                        group: 'Groupe',
                        class: 'Classe',
                        announcement: 'Annonce'
                    };
                    return types[type] || type;
                },
                
                getEventTypeClass(type) {
                    const classes = {
                        school: 'bg-blue-100 text-blue-800',
                        class: 'bg-green-100 text-green-800',
                        celebration: 'bg-purple-100 text-purple-800',
                        parent_meeting: 'bg-orange-100 text-orange-800',
                        activity: 'bg-yellow-100 text-yellow-800'
                    };
                    return classes[type] || 'bg-gray-100 text-gray-800';
                },
                
                getEventTypeText(type) {
                    const texts = {
                        school: '√âcole',
                        class: 'Classe', 
                        celebration: 'F√™te',
                        parent_meeting: 'R√©union',
                        activity: 'Activit√©',
                        general: 'G√©n√©ral'
                    };
                    return texts[type] || type;
                },
                
                formatEventDate(dateStr) {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('fr-BE', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                },
                
                formatTime(dateStr) {
                    return new Date(dateStr).toLocaleTimeString('fr-BE', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                
                async loadOtherUsers() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/users/list', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.otherUsers = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur utilisateurs:', error);
                    }
                },
                
                async createDirectMessage() {
                    if (!this.newDirectMessage.user_id || !this.newDirectMessage.content.trim()) return;
                    
                    this.isLoading = true;
                    
                    try {
                        const token = localStorage.getItem('token');
                        
                        // 1. Cr√©er ou obtenir conversation directe
                        const conversationResponse = await fetch('/api/conversations/direct', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` },
                            body: new FormData(Object.assign(document.createElement('form'), {
                                innerHTML: `<input name="other_user_id" value="${this.newDirectMessage.user_id}">`
                            }))
                        });
                        
                        if (conversationResponse.ok) {
                            const conversationData = await conversationResponse.json();
                            
                            // 2. Envoyer le message
                            const messageResponse = await fetch(`/conversations/${conversationData.conversation_id}/messages`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    content: this.newDirectMessage.content
                                })
                            });
                            
                            if (messageResponse.ok) {
                                this.showNewMessageForm = false;
                                this.newDirectMessage = { user_id: '', content: '' };
                                await this.loadConversations();
                                this.successMessage = 'Message envoy√© !';
                            }
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur envoi message';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async messageServiceOwner(service) {
                    // Message rapide au propri√©taire d'un service
                    const message = prompt(`Message pour ${service.user?.first_name || 'le propri√©taire'} du service "${service.title}":`);
                    if (!message?.trim()) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        
                        // Cr√©er conversation directe
                        const formData = new FormData();
                        formData.append('other_user_id', service.user_id);
                        
                        const conversationResponse = await fetch('/api/conversations/direct', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` },
                            body: formData
                        });
                        
                        if (conversationResponse.ok) {
                            const conversationData = await conversationResponse.json();
                            
                            // Envoyer message avec contexte du service
                            const contextMessage = `√Ä propos de votre service "${service.title}": ${message}`;
                            
                            const messageResponse = await fetch(`/conversations/${conversationData.conversation_id}/messages`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ content: contextMessage })
                            });
                            
                            if (messageResponse.ok) {
                                this.successMessage = 'Message envoy√© au propri√©taire du service !';
                                this.currentTab = 'messages';
                                await this.loadConversations();
                            }
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur envoi message';
                    }
                },
                
                async loadShopProducts() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/shop/products', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.shopProducts = await response.json();
                            console.log('üõí Produits boutique charg√©s:', this.shopProducts.length);
                        }
                    } catch (error) {
                        console.error('Erreur produits boutique:', error);
                    }
                },
                
                async loadEducationResources() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/education/resources', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.educationResources = await response.json();
                            console.log('üìö Ressources √©ducation charg√©es:', this.educationResources.length);
                        }
                    } catch (error) {
                        console.error('Erreur ressources √©ducation:', error);
                    }
                },
                
                async expressInterest(product) {
                    const quantity = prompt(`Combien de "${product.name}" souhaitez-vous ?`, '1');
                    if (!quantity || isNaN(quantity) || quantity <= 0) return;
                    
                    const notes = prompt('Notes particuli√®res (taille, couleur...) :', '');
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/shop/products/${product.id}/interest`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                quantity: parseInt(quantity),
                                notes: notes
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            await this.loadShopProducts();
                            this.successMessage = result.message;
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur expression int√©r√™t';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                async cancelInterest(productId) {
                    if (!confirm('Annuler votre int√©r√™t pour ce produit ?')) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/shop/products/${productId}/interest`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            await this.loadShopProducts();
                            this.successMessage = 'Int√©r√™t annul√©';
                        } else {
                            this.errorMessage = 'Erreur annulation int√©r√™t';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                // Admin Methods
                async createGroupOrder(productId) {
                    if (!confirm('Lancer la commande group√©e pour ce produit ?')) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/shop/products/${productId}/order`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            await this.loadShopProducts();
                            this.successMessage = `Commande group√©e cr√©√©e ! ${result.participants} participants, Total: ${result.total_price}‚Ç¨`;
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur cr√©ation commande';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                async toggleProductActive(product) {
                    const action = product.is_active ? 'd√©sactiver' : 'activer';
                    if (!confirm(`${action} le produit "${product.name}" ?`)) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/shop/products/${product.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                is_active: !product.is_active
                            })
                        });
                        
                        if (response.ok) {
                            await this.loadShopProducts();
                            this.successMessage = `Produit ${product.is_active ? 'd√©sactiv√©' : 'activ√©'}`;
                        } else {
                            this.errorMessage = 'Erreur modification produit';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                async createProduct() {
                    this.isLoading = true;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/api/shop/products', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(this.newProduct)
                        });
                        
                        if (response.ok) {
                            await this.loadShopProducts();
                            this.showProductForm = false;
                            this.resetProductForm();
                            this.successMessage = 'Produit cr√©√© avec succ√®s !';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur cr√©ation produit';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                resetProductForm() {
                    this.newProduct = {
                        name: '',
                        description: '',
                        category: '',
                        base_price: 0,
                        min_quantity: 10
                    };
                },
                
                async changeLanguage() {
                    await window.EcoleHubI18n.setLocale(this.currentLanguage);
                    this.$forceUpdate(); // Force Vue to re-render with new translations
                },
                
                logout() {
                    // Stop message polling
                    this.stopMessagePolling();
                    
                    localStorage.removeItem('token');
                    this.isAuthenticated = false;
                    this.user = null;
                    this.currentTab = 'dashboard';
                    this.selectedConversation = null;
                    this.conversationMessages = [];
                    this.successMessage = 'D√©connexion r√©ussie';
                }
            }
        });
        
        // Install i18n plugin
        app.use(window.I18nPlugin);
        
        // Mount the app
        app.mount('#app');
    </script>
</body>
</html>
