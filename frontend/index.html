<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoleHub Stage 3</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" v-cloak class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-6xl mx-auto px-4 py-6">
                <h1 class="text-3xl font-bold text-gray-900">
                    üè´ EcoleHub Stage 3
                </h1>
                <p class="text-gray-600 mt-2">Plateforme collaborative compl√®te - Boutique + √âducation</p>
                <div v-if="isAuthenticated" class="mt-2 flex justify-between items-center">
                    <span class="text-sm text-green-600">
                        Connect√©: {{ user.first_name }} {{ user.last_name }}
                    </span>
                    <div v-if="balance" class="text-sm">
                        <span class="font-semibold" :class="balanceColor">
                            üí∞ {{ balance.balance }} unit√©s
                        </span>
                        <span class="text-gray-500 ml-2">SEL</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto px-4 py-8">
            <!-- Messages -->
            <div v-if="errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                {{ errorMessage }}
                <button @click="errorMessage = ''" class="float-right text-red-700 hover:text-red-900">√ó</button>
            </div>

            <div v-if="successMessage" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                {{ successMessage }}
                <button @click="successMessage = ''" class="float-right text-green-700 hover:text-green-900">√ó</button>
            </div>

            <!-- Login/Register -->
            <div v-if="!isAuthenticated" class="max-w-md mx-auto">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-6 text-center">
                        {{ isLogin ? 'Connexion' : 'Inscription' }}
                    </h2>
                    
                    <form @submit.prevent="isLogin ? login() : register()">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                            <input
                                v-model="formData.email"
                                type="email"
                                class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                placeholder="votre.email@ecolehub.local"
                            >
                        </div>
                        
                        <div v-if="!isLogin" class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Pr√©nom</label>
                            <input
                                v-model="formData.first_name"
                                type="text"
                                class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                placeholder="Pr√©nom"
                            >
                        </div>
                        
                        <div v-if="!isLogin" class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Nom</label>
                            <input
                                v-model="formData.last_name"
                                type="text"
                                class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                placeholder="Nom de famille"
                            >
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Mot de passe</label>
                            <input
                                v-model="formData.password"
                                type="password"
                                class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                minlength="6"
                            >
                        </div>
                        
                        <button
                            type="submit"
                            :disabled="isLoading"
                            class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 disabled:opacity-50"
                        >
                            <span v-if="isLoading">‚è≥ Chargement...</span>
                            <span v-else>{{ isLogin ? 'Se connecter' : "S'inscrire" }}</span>
                        </button>
                    </form>
                    
                    <p class="mt-6 text-center text-gray-600">
                        <a href="#" @click.prevent="toggleForm" class="text-blue-500 hover:underline">
                            {{ isLogin ? "Pas encore de compte ? S'inscrire" : "D√©j√† inscrit ? Se connecter" }}
                        </a>
                    </p>
                </div>
            </div>

            <!-- Dashboard Utilisateur Connect√© -->
            <div v-else>
                <!-- Navigation -->
                <nav class="bg-white rounded-lg shadow mb-6">
                    <div class="flex space-x-4 p-4">
                        <button
                            @click="currentTab = 'dashboard'"
                            :class="{'bg-blue-500 text-white': currentTab === 'dashboard', 'text-blue-500': currentTab !== 'dashboard'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üè† Dashboard
                        </button>
                        <button
                            @click="currentTab = 'services'"
                            :class="{'bg-blue-500 text-white': currentTab === 'services', 'text-blue-500': currentTab !== 'services'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üíº Services SEL
                        </button>
                        <button
                            @click="currentTab = 'transactions'"
                            :class="{'bg-blue-500 text-white': currentTab === 'transactions', 'text-blue-500': currentTab !== 'transactions'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üí± Transactions
                        </button>
                        <button
                            @click="currentTab = 'messages'"
                            :class="{'bg-blue-500 text-white': currentTab === 'messages', 'text-blue-500': currentTab !== 'messages'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üí¨ Messages
                        </button>
                        <button
                            @click="currentTab = 'events'"
                            :class="{'bg-blue-500 text-white': currentTab === 'events', 'text-blue-500': currentTab !== 'events'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üìÖ √âv√©nements
                        </button>
                        <button
                            @click="currentTab = 'shop'"
                            :class="{'bg-blue-500 text-white': currentTab === 'shop', 'text-blue-500': currentTab !== 'shop'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üõí Boutique
                        </button>
                        <button
                            @click="currentTab = 'education'"
                            :class="{'bg-blue-500 text-white': currentTab === 'education', 'text-blue-500': currentTab !== 'education'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üìö √âducation
                        </button>
                        <button
                            @click="currentTab = 'profile'"
                            :class="{'bg-blue-500 text-white': currentTab === 'profile', 'text-blue-500': currentTab !== 'profile'}"
                            class="px-4 py-2 rounded-lg font-medium"
                        >
                            üë§ Profil
                        </button>
                    </div>
                </nav>

                <!-- Dashboard Tab -->
                <div v-if="currentTab === 'dashboard'">
                    <!-- Balance SEL -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üí∞ Ma Balance SEL</h2>
                        <div v-if="balance" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <div class="text-3xl font-bold" :class="balanceColor">{{ balance.balance }}</div>
                                <div class="text-gray-600">Unit√©s actuelles</div>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">{{ balance.total_received }}</div>
                                <div class="text-gray-600">Re√ßues</div>
                            </div>
                            <div class="text-center p-4 bg-orange-50 rounded-lg">
                                <div class="text-2xl font-bold text-orange-600">{{ balance.total_given }}</div>
                                <div class="text-gray-600">Donn√©es</div>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-gray-600">
                            <p><strong>R√®gles belges :</strong> -300 √† +600 unit√©s ‚Ä¢ 60 unit√©s = 1 heure</p>
                        </div>
                    </div>

                    <!-- Services Disponibles -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üõçÔ∏è Services Disponibles</h2>
                        <div v-if="availableServices.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="service in availableServices" :key="service.id" 
                                 class="border rounded-lg p-4 hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-semibold">{{ service.title }}</h3>
                                    <span class="text-2xl">{{ getCategoryIcon(service.category) }}</span>
                                </div>
                                <p class="text-gray-600 text-sm mb-3">{{ service.description }}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-600 font-medium">{{ service.units_per_hour }} unit√©s/h</span>
                                    <div class="flex space-x-2">
                                        <button 
                                            @click="requestService(service)"
                                            class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
                                        >
                                            Demander
                                        </button>
                                        <button 
                                            @click="messageServiceOwner(service)"
                                            class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600"
                                        >
                                            üí¨ Message
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p v-else class="text-gray-500">Aucun service disponible pour le moment.</p>
                    </div>
                </div>

                <!-- Services Tab -->
                <div v-if="currentTab === 'services'">
                    <!-- Mes Services -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üíº Mes Services</h2>
                        
                        <!-- Liste mes services -->
                        <div v-if="myServices.length > 0" class="space-y-4 mb-6">
                            <div v-for="service in myServices" :key="service.id" 
                                 class="flex items-center justify-between border rounded-lg p-4">
                                <div class="flex-1">
                                    <h3 class="font-semibold">{{ service.title }}</h3>
                                    <p class="text-gray-600 text-sm">{{ service.description }}</p>
                                    <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs mt-2">
                                        {{ getCategoryIcon(service.category) }} {{ service.category }}
                                    </span>
                                </div>
                                <div class="text-right">
                                    <div class="font-medium">{{ service.units_per_hour }} unit√©s/h</div>
                                    <div class="text-sm" :class="service.is_active ? 'text-green-600' : 'text-red-600'">
                                        {{ service.is_active ? 'Actif' : 'Inactif' }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Formulaire nouveau service -->
                        <h3 class="text-lg font-semibold mb-4">Proposer un nouveau service</h3>
                        <form @submit.prevent="createService()" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">Titre du service</label>
                                    <input
                                        v-model="serviceForm.title"
                                        type="text"
                                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                        placeholder="ex: Garde apr√®s √©cole"
                                    >
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">Cat√©gorie</label>
                                    <select
                                        v-model="serviceForm.category"
                                        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                        @change="onCategoryChange"
                                    >
                                        <option value="">Choisir une cat√©gorie</option>
                                        <option v-for="cat in categories" :key="cat.id" :value="cat.name">
                                            {{ cat.icon }} {{ cat.name }} - {{ cat.description }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Champ pour nouvelle cat√©gorie si "proposition" s√©lectionn√© -->
                            <div v-if="serviceForm.category === 'proposition'" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">
                                    üí≠ Nom de la nouvelle cat√©gorie propos√©e
                                </label>
                                <input
                                    v-model="serviceForm.new_category_name"
                                    type="text"
                                    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="ex: Musique, Sport, Informatique..."
                                    :required="serviceForm.category === 'proposition'"
                                >
                                <div class="text-xs text-yellow-700 mt-1">
                                    Cette proposition sera visible aux autres parents et pourra devenir une nouvelle cat√©gorie officielle.
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                                <textarea
                                    v-model="serviceForm.description"
                                    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    rows="3"
                                    :placeholder="serviceForm.category === 'proposition' ? 'D√©crivez en d√©tail ce nouveau type de service...' : 'D√©crivez votre service...'"
                                ></textarea>
                            </div>
                            <div class="w-full md:w-1/2">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Unit√©s par heure</label>
                                <input
                                    v-model.number="serviceForm.units_per_hour"
                                    type="number"
                                    min="30"
                                    max="120"
                                    class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    placeholder="60"
                                >
                                <div class="text-xs text-gray-500 mt-1">Standard: 60 unit√©s = 1 heure</div>
                            </div>
                            <button
                                type="submit"
                                :disabled="isLoading"
                                class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 disabled:opacity-50"
                            >
                                Cr√©er le service
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Transactions Tab -->
                <div v-if="currentTab === 'transactions'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">üí± Mes Transactions</h2>
                        
                        <div v-if="transactions.length > 0" class="space-y-4">
                            <div v-for="transaction in transactions" :key="transaction.id"
                                 class="border rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="font-semibold">
                                            {{ transaction.from_user_id === user.id ? '‚Üí' : '‚Üê' }}
                                            {{ transaction.units }} unit√©s
                                        </div>
                                        <div class="text-sm text-gray-600">
                                            {{ formatDate(transaction.created_at) }}
                                        </div>
                                    </div>
                                    <span class="px-2 py-1 rounded text-xs"
                                          :class="getStatusClass(transaction.status)">
                                        {{ getStatusText(transaction.status) }}
                                    </span>
                                </div>
                                <p v-if="transaction.description" class="text-gray-600 text-sm mb-2">
                                    {{ transaction.description }}
                                </p>
                                
                                <!-- Actions -->
                                <div v-if="transaction.status === 'pending'" class="flex space-x-2 mt-3">
                                    <button v-if="transaction.to_user_id === user.id"
                                            @click="approveTransaction(transaction.id)"
                                            class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                        ‚úÖ Approuver
                                    </button>
                                    <button @click="cancelTransaction(transaction.id)"
                                            class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        ‚ùå Annuler
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p v-else class="text-gray-500">Aucune transaction pour le moment.</p>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div v-if="currentTab === 'messages'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">üí¨ Messages</h2>
                            <button 
                                @click="showNewMessageForm = !showNewMessageForm"
                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                            >
                                ‚úâÔ∏è Nouveau message
                            </button>
                        </div>
                        
                        <!-- Formulaire nouveau message direct -->
                        <div v-if="showNewMessageForm" class="bg-gray-50 border rounded-lg p-4 mb-6">
                            <h3 class="font-semibold mb-3">Envoyer un message direct</h3>
                            <form @submit.prevent="createDirectMessage()" class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">Destinataire</label>
                                    <select
                                        v-model="newDirectMessage.user_id"
                                        class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    >
                                        <option value="">Choisir un parent</option>
                                        <option v-for="user in otherUsers" :key="user.id" :value="user.id">
                                            {{ user.name }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">Message</label>
                                    <textarea
                                        v-model="newDirectMessage.content"
                                        class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        rows="3"
                                        placeholder="Votre message..."
                                        required
                                    ></textarea>
                                </div>
                                <div class="flex space-x-2">
                                    <button
                                        type="submit"
                                        :disabled="isLoading"
                                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:opacity-50"
                                    >
                                        Envoyer
                                    </button>
                                    <button
                                        type="button"
                                        @click="showNewMessageForm = false; newDirectMessage = {user_id: '', content: ''}"
                                        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                                    >
                                        Annuler
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Liste des conversations -->
                        <div v-if="conversations.length > 0" class="space-y-3 mb-6">
                            <div v-for="conversation in conversations" :key="conversation.id"
                                 @click="openConversation(conversation)"
                                 class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <h3 class="font-semibold">{{ conversation.name }}</h3>
                                        <p v-if="conversation.last_message" class="text-gray-600 text-sm mt-1">
                                            {{ conversation.last_message.user_name }}: {{ conversation.last_message.content }}
                                        </p>
                                        <p v-else class="text-gray-500 text-sm mt-1">Aucun message</p>
                                    </div>
                                    <div class="text-right text-sm text-gray-500">
                                        <div class="flex items-center space-x-2">
                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                                                {{ getConversationType(conversation.type) }}
                                            </span>
                                            <span v-if="conversation.class_name" class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">
                                                {{ conversation.class_name }}
                                            </span>
                                        </div>
                                        <div v-if="conversation.last_message" class="mt-1">
                                            {{ formatDate(conversation.last_message.created_at) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p v-else class="text-gray-500">Aucune conversation pour le moment.</p>
                        
                        <!-- Messages de la conversation s√©lectionn√©e -->
                        <div v-if="selectedConversation" class="mt-6 border-t pt-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold">{{ selectedConversation.name }}</h3>
                                <button 
                                    @click="loadConversationMessages()"
                                    class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600"
                                    title="Actualiser les messages"
                                >
                                    üîÑ Actualiser
                                </button>
                            </div>
                            
                            <!-- Zone de messages -->
                            <div class="h-64 overflow-y-auto border rounded-lg p-4 mb-4 bg-gray-50">
                                <div v-if="conversationMessages.length > 0" class="space-y-3">
                                    <div v-for="message in conversationMessages" :key="message.id"
                                         :class="{'text-right': message.user_id === user.id}"
                                         class="flex"
                                         :class="message.user_id === user.id ? 'justify-end' : 'justify-start'">
                                        <div :class="message.user_id === user.id ? 'bg-blue-500 text-white' : 'bg-white'"
                                             class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg shadow">
                                            <div v-if="message.user_id !== user.id" class="text-xs text-gray-600 mb-1">
                                                {{ message.user_name }}
                                            </div>
                                            <div>{{ message.content }}</div>
                                            <div class="text-xs mt-1" :class="message.user_id === user.id ? 'text-blue-100' : 'text-gray-500'">
                                                {{ formatTime(message.created_at) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p v-else class="text-gray-500 text-center">Aucun message dans cette conversation</p>
                            </div>
                            
                            <!-- Formulaire nouveau message -->
                            <form @submit.prevent="sendMessage()" class="flex space-x-2">
                                <input
                                    v-model="newMessage"
                                    type="text"
                                    placeholder="Tapez votre message..."
                                    class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    maxlength="500"
                                >
                                <button
                                    type="submit"
                                    :disabled="!newMessage.trim() || isLoading"
                                    class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 disabled:opacity-50"
                                >
                                    Envoyer
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Events Tab -->
                <div v-if="currentTab === 'events'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">üìÖ √âv√©nements √âcole</h2>
                        
                        <!-- Filtres √©v√©nements -->
                        <div class="mb-6 flex flex-wrap gap-2">
                            <button
                                @click="eventFilter = 'all'"
                                :class="eventFilter === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                Tous
                            </button>
                            <button
                                @click="eventFilter = 'school'"
                                :class="eventFilter === 'school' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                üè´ √âcole
                            </button>
                            <button
                                @click="eventFilter = 'class'"
                                :class="eventFilter === 'class' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                üìö Classes
                            </button>
                            <button
                                @click="eventFilter = 'celebration'"
                                :class="eventFilter === 'celebration' ? 'bg-blue-500 text-white' : 'bg-gray-200'"
                                class="px-3 py-1 rounded-full text-sm"
                            >
                                üéâ F√™tes
                            </button>
                        </div>
                        
                        <!-- Liste des √©v√©nements -->
                        <div v-if="filteredEvents.length > 0" class="space-y-4">
                            <div v-for="event in filteredEvents" :key="event.id"
                                 class="border rounded-lg p-4 hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <h3 class="text-lg font-semibold">{{ event.title }}</h3>
                                        <p v-if="event.description" class="text-gray-600 text-sm mt-1">{{ event.description }}</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="px-2 py-1 rounded-full text-xs" :class="getEventTypeClass(event.event_type)">
                                            {{ getEventTypeText(event.event_type) }}
                                        </span>
                                        <div v-if="event.class_name" class="mt-1">
                                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">
                                                {{ event.class_name }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <span class="font-medium">üìÖ Date:</span>
                                        <div>{{ formatEventDate(event.start_date) }}</div>
                                        <div v-if="event.end_date" class="text-gray-600">
                                            jusqu'√† {{ formatTime(event.end_date) }}
                                        </div>
                                    </div>
                                    <div v-if="event.location">
                                        <span class="font-medium">üìç Lieu:</span>
                                        <div>{{ event.location }}</div>
                                    </div>
                                    <div v-if="event.registration_required">
                                        <span class="font-medium">üë• Participants:</span>
                                        <div>{{ event.participants_count }}{{ event.max_participants ? '/' + event.max_participants : '' }}</div>
                                    </div>
                                </div>
                                
                                <!-- Actions √©v√©nement -->
                                <div v-if="event.registration_required" class="mt-4 flex space-x-2">
                                    <button
                                        v-if="!event.is_registered"
                                        @click="registerForEvent(event.id)"
                                        :disabled="isLoading || (event.max_participants && event.participants_count >= event.max_participants)"
                                        class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:opacity-50"
                                    >
                                        {{ (event.max_participants && event.participants_count >= event.max_participants) ? 'Complet' : "S'inscrire" }}
                                    </button>
                                    <div v-else class="flex items-center text-green-600">
                                        ‚úÖ Inscrit
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p v-else class="text-gray-500">Aucun √©v√©nement {{ eventFilter === 'all' ? '' : 'dans cette cat√©gorie' }}.</p>
                    </div>
                </div>

                <!-- Shop Tab -->
                <div v-if="currentTab === 'shop'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">üõí Boutique EcoleHub</h2>
                        
                        <!-- Coming soon message -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                            <div class="text-6xl mb-4">üèóÔ∏è</div>
                            <h3 class="text-xl font-semibold text-blue-800 mb-2">Boutique Collaborative en Construction</h3>
                            <p class="text-blue-700 mb-4">
                                Prochainement : Commandes group√©es de fournitures scolaires, 
                                T-shirts avec logo √©cole, agendas personnalis√©s...
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                                <div class="bg-white p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">üéΩ Articles EcoleHub</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>‚Ä¢ T-shirts avec logo √©cole</li>
                                        <li>‚Ä¢ Sacs √† dos √©cole</li>
                                        <li>‚Ä¢ Agendas scolaires personnalis√©s</li>
                                        <li>‚Ä¢ Cahiers avec logo √©cole</li>
                                    </ul>
                                </div>
                                <div class="bg-white p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">üìö Fournitures Group√©es</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>‚Ä¢ Listes fournitures par classe</li>
                                        <li>‚Ä¢ Commandes group√©es parents</li>
                                        <li>‚Ä¢ Prix pr√©f√©rentiels n√©goci√©s</li>
                                        <li>‚Ä¢ Livraison √©cole directe</li>
                                    </ul>
                                </div>
                            </div>
                            <p class="text-sm text-blue-600 mt-4">
                                üí≥ Paiements via Mollie (Bancontact, carte, virement)
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Education Tab -->
                <div v-if="currentTab === 'education'">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-4">üìö √âducation EcoleHub</h2>
                        
                        <!-- Coming soon message -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                            <div class="text-6xl mb-4">üìñ</div>
                            <h3 class="text-xl font-semibold text-green-800 mb-2">Module √âducatif en D√©veloppement</h3>
                            <p class="text-green-700 mb-4">
                                Prochainement : Ressources p√©dagogiques, listes de fournitures, 
                                calendrier scolaire et communications √©cole.
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                                <div class="bg-white p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">üìã Ressources Classe</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>‚Ä¢ Listes fournitures P1-P6, M1-M3</li>
                                        <li>‚Ä¢ Calendrier scolaire belge</li>
                                        <li>‚Ä¢ Formulaires √©cole (inscriptions, sorties)</li>
                                        <li>‚Ä¢ R√®glement int√©rieur √©cole</li>
                                    </ul>
                                </div>
                                <div class="bg-white p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-800 mb-2">üì¢ Communications</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>‚Ä¢ Annonces direction √©cole</li>
                                        <li>‚Ä¢ Projet √©ducatif EcoleHub</li>
                                        <li>‚Ä¢ Info r√©unions parents</li>
                                        <li>‚Ä¢ √âv√©nements sp√©ciaux √©cole</li>
                                    </ul>
                                </div>
                            </div>
                            <p class="text-sm text-green-600 mt-4">
                                üìÅ Stockage s√©curis√© avec acc√®s contr√¥l√© par classe
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Profile Tab -->
                <div v-if="currentTab === 'profile'">
                    <!-- Profil Utilisateur -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üë§ Mon Profil</h2>
                        <div class="space-y-2">
                            <p><strong>Email:</strong> {{ user.email }}</p>
                            <p><strong>Pr√©nom:</strong> {{ user.first_name }}</p>
                            <p><strong>Nom:</strong> {{ user.last_name }}</p>
                        </div>
                    </div>

                    <!-- Enfants -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 class="text-2xl font-bold mb-4">üë∂ Mes Enfants</h2>
                        
                        <div v-if="children.length > 0" class="space-y-3 mb-6">
                            <div v-for="child in children" :key="child.id"
                                 class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <div>
                                    <span class="font-semibold">{{ child.first_name }}</span>
                                    <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">
                                        {{ child.class_name }}
                                    </span>
                                </div>
                                <button @click="deleteChild(child.id)" class="text-red-500 hover:text-red-700">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        <form @submit.prevent="addChild()" class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">Pr√©nom de l'enfant</label>
                                    <input
                                        v-model="childForm.first_name"
                                        type="text"
                                        class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    >
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2">Classe</label>
                                    <select
                                        v-model="childForm.class_name"
                                        class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    >
                                        <option value="">Choisir une classe</option>
                                        <option value="M1">M1 (1√®re maternelle)</option>
                                        <option value="M2">M2 (2√®me maternelle)</option>
                                        <option value="M3">M3 (3√®me maternelle)</option>
                                        <option value="P1">P1 (1√®re primaire)</option>
                                        <option value="P2">P2 (2√®me primaire)</option>
                                        <option value="P3">P3 (3√®me primaire)</option>
                                        <option value="P4">P4 (4√®me primaire)</option>
                                        <option value="P5">P5 (5√®me primaire)</option>
                                        <option value="P6">P6 (6√®me primaire)</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                Ajouter l'enfant
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Info Stage 2 -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-2">üöÄ Stage 2 - Messages + √âv√©nements</h3>
                    <p class="text-blue-700">
                        Nouvelles fonctionnalit√©s : Messagerie temps r√©el + √âv√©nements √©cole.
                        <br>
                        <strong>Prochaine √©tape :</strong> Boutique collaborative (Stage 3).
                    </p>
                </div>

                <!-- D√©connexion -->
                <div class="text-center">
                    <button @click="logout()" class="bg-red-500 text-white px-6 py-2 rounded hover:bg-red-600">
                        Se d√©connecter
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    // √âtat global
                    isLoading: false,
                    errorMessage: '',
                    successMessage: '',
                    currentTab: 'dashboard',
                    
                    // Auth
                    isLogin: true,
                    isAuthenticated: false,
                    user: null,
                    
                    // Forms
                    formData: { email: '', first_name: '', last_name: '', password: '' },
                    childForm: { first_name: '', class_name: '' },
                    serviceForm: { title: '', description: '', category: '', units_per_hour: 60, new_category_name: '' },
                    
                    // SEL Data
                    balance: null,
                    categories: [],
                    myServices: [],
                    availableServices: [],
                    transactions: [],
                    children: [],
                    
                    // Stage 2: Messaging Data
                    conversations: [],
                    selectedConversation: null,
                    conversationMessages: [],
                    newMessage: '',
                    showNewMessageForm: false,
                    newDirectMessage: { user_id: '', content: '' },
                    otherUsers: [],
                    messagePolling: null,
                    
                    // Stage 2: Events Data
                    events: [],
                    eventFilter: 'all'
                }
            },
            
            computed: {
                balanceColor() {
                    if (!this.balance) return 'text-gray-600';
                    if (this.balance.balance < 0) return 'text-red-600';
                    if (this.balance.balance > 300) return 'text-green-600';
                    return 'text-blue-600';
                },
                
                filteredEvents() {
                    if (this.eventFilter === 'all') return this.events;
                    return this.events.filter(event => event.event_type === this.eventFilter);
                }
            },
            
            async mounted() {
                const token = localStorage.getItem('token');
                if (token) {
                    await this.loadUserData(token);
                }
                await this.loadCategories();
                
                // Events will be loaded after authentication
            },
            
            methods: {
                async loadUserData(token) {
                    try {
                        const userResponse = await fetch('/me', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (userResponse.ok) {
                            this.user = await userResponse.json();
                            this.isAuthenticated = true;
                            await this.loadAllData();
                        } else {
                            localStorage.removeItem('token');
                        }
                    } catch (error) {
                        console.error('Erreur chargement utilisateur:', error);
                        localStorage.removeItem('token');
                    }
                },
                
                async loadAllData() {
                    await Promise.all([
                        this.loadBalance(),
                        this.loadChildren(),
                        this.loadMyServices(),
                        this.loadAvailableServices(),
                        this.loadTransactions(),
                        this.loadConversations(),
                        this.loadOtherUsers()
                    ]);
                    
                    // Load events after other data
                    await this.loadEvents();
                },
                
                async loadBalance() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/sel/balance', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.balance = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur balance:', error);
                    }
                },
                
                async loadCategories() {
                    try {
                        const response = await fetch('/sel/categories');
                        if (response.ok) {
                            this.categories = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur cat√©gories:', error);
                    }
                },
                
                async loadMyServices() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/sel/services/mine', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.myServices = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur services:', error);
                    }
                },
                
                async loadAvailableServices() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/sel/services', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.availableServices = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur services disponibles:', error);
                    }
                },
                
                async loadTransactions() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/sel/transactions', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.transactions = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur transactions:', error);
                    }
                },
                
                async loadChildren() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/children', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.children = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur enfants:', error);
                    }
                },
                
                async register() {
                    this.isLoading = true;
                    this.errorMessage = '';
                    
                    try {
                        const response = await fetch('/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.formData)
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            localStorage.setItem('token', data.access_token);
                            await this.loadUserData(data.access_token);
                            this.successMessage = 'Inscription r√©ussie ! Balance SEL: 120 unit√©s cr√©√©e.';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur inscription';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion au serveur';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async login() {
                    this.isLoading = true;
                    this.errorMessage = '';
                    
                    try {
                        const formData = new FormData();
                        formData.append('email', this.formData.email);
                        formData.append('password', this.formData.password);
                        
                        const response = await fetch('/login', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            localStorage.setItem('token', data.access_token);
                            await this.loadUserData(data.access_token);
                            this.successMessage = 'Connexion r√©ussie !';
                        } else {
                            this.errorMessage = 'Email ou mot de passe incorrect';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion au serveur';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async createService() {
                    this.isLoading = true;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/sel/services', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(this.serviceForm)
                        });
                        
                        if (response.ok) {
                            await this.loadMyServices();
                            await this.loadAvailableServices();
                            this.serviceForm = { title: '', description: '', category: '', units_per_hour: 60, new_category_name: '' };
                            const message = this.serviceForm.category === 'proposition' 
                                ? 'Proposition de service cr√©√©e ! Elle sera visible aux autres parents.'
                                : 'Service cr√©√© avec succ√®s !';
                            this.successMessage = message;
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur cr√©ation service';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async addChild() {
                    this.isLoading = true;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/children', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(this.childForm)
                        });
                        
                        if (response.ok) {
                            await this.loadChildren();
                            this.childForm = { first_name: '', class_name: '' };
                            this.successMessage = 'Enfant ajout√© !';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur ajout enfant';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async deleteChild(childId) {
                    if (!confirm('Supprimer cet enfant ?')) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/children/${childId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            await this.loadChildren();
                            this.successMessage = 'Enfant supprim√©';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur suppression';
                    }
                },
                
                onCategoryChange() {
                    // Reset new category name if not proposition
                    if (this.serviceForm.category !== 'proposition') {
                        this.serviceForm.new_category_name = '';
                    }
                },
                
                getCategoryIcon(category) {
                    const cat = this.categories.find(c => c.name === category);
                    return cat ? cat.icon : 'üí°';
                },
                
                getStatusClass(status) {
                    const classes = {
                        pending: 'bg-yellow-100 text-yellow-800',
                        approved: 'bg-green-100 text-green-800',
                        completed: 'bg-blue-100 text-blue-800',
                        cancelled: 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },
                
                getStatusText(status) {
                    const texts = {
                        pending: 'En attente',
                        approved: 'Approuv√©e', 
                        completed: 'Termin√©e',
                        cancelled: 'Annul√©e'
                    };
                    return texts[status] || status;
                },
                
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleString('fr-BE');
                },
                
                toggleForm() {
                    this.isLogin = !this.isLogin;
                    this.formData = { email: '', first_name: '', last_name: '', password: '' };
                    this.errorMessage = '';
                },
                
                async requestService(service) {
                    // Demander un service √† un autre parent
                    const units = prompt(`Combien d'unit√©s demander pour "${service.title}" ?\n(${service.units_per_hour} unit√©s/heure)`);
                    if (!units || isNaN(units) || units <= 0) return;
                    
                    const description = prompt('Description de votre demande:');
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/sel/transactions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                to_user_id: service.user_id,
                                service_id: service.id,
                                units: parseInt(units),
                                description: description
                            })
                        });
                        
                        if (response.ok) {
                            await this.loadTransactions();
                            await this.loadBalance();
                            this.successMessage = 'Demande de service cr√©√©e ! En attente d\'approbation.';
                            this.currentTab = 'transactions';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur cr√©ation demande';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                async approveTransaction(transactionId) {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/sel/transactions/${transactionId}/approve`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            await this.loadTransactions();
                            await this.loadBalance();
                            this.successMessage = 'Transaction approuv√©e ! Balances mises √† jour.';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur approbation';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                async cancelTransaction(transactionId) {
                    if (!confirm('Annuler cette transaction ?')) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/sel/transactions/${transactionId}/cancel`, {
                            method: 'PUT',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            await this.loadTransactions();
                            this.successMessage = 'Transaction annul√©e.';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur annulation';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                async loadConversations() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/conversations', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.conversations = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur conversations:', error);
                    }
                },
                
                async loadEvents() {
                    try {
                        const token = localStorage.getItem('token');
                        console.log('üîç Loading events with token:', token ? 'EXISTS' : 'MISSING');
                        
                        const response = await fetch('/events', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        console.log('üîç Events API response status:', response.status);
                        
                        if (response.ok) {
                            const eventsData = await response.json();
                            this.events = eventsData;
                            console.log('üìÖ √âv√©nements charg√©s:', this.events.length, 'Donn√©es:', eventsData);
                        } else {
                            const errorData = await response.text();
                            console.error('‚ùå Erreur API events:', response.status, errorData);
                        }
                    } catch (error) {
                        console.error('Erreur √©v√©nements:', error);
                    }
                },
                
                async openConversation(conversation) {
                    this.selectedConversation = conversation;
                    await this.loadConversationMessages();
                    
                    // Start polling for new messages every 3 seconds
                    this.startMessagePolling();
                },
                
                async loadConversationMessages() {
                    if (!this.selectedConversation) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/conversations/${this.selectedConversation.id}/messages`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.conversationMessages = await response.json();
                            
                            // Auto-scroll to bottom
                            this.$nextTick(() => {
                                const messagesDiv = document.querySelector('.overflow-y-auto');
                                if (messagesDiv) {
                                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Erreur messages:', error);
                    }
                },
                
                startMessagePolling() {
                    // Clear existing polling
                    if (this.messagePolling) {
                        clearInterval(this.messagePolling);
                    }
                    
                    // Start new polling every 3 seconds
                    this.messagePolling = setInterval(() => {
                        if (this.selectedConversation && this.currentTab === 'messages') {
                            this.loadConversationMessages();
                        }
                    }, 3000);
                },
                
                stopMessagePolling() {
                    if (this.messagePolling) {
                        clearInterval(this.messagePolling);
                        this.messagePolling = null;
                    }
                },
                
                async sendMessage() {
                    if (!this.selectedConversation || !this.newMessage.trim()) return;
                    
                    // TODO: Implement WebSocket message sending
                    // For now, use HTTP API
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/conversations/${this.selectedConversation.id}/messages`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                content: this.newMessage
                            })
                        });
                        
                        if (response.ok) {
                            this.newMessage = '';
                            await this.loadConversationMessages();
                        }
                    } catch (error) {
                        console.error('Erreur envoi message:', error);
                    }
                },
                
                async registerForEvent(eventId) {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/events/${eventId}/register`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            await this.loadEvents();
                            this.successMessage = 'Inscription √† l\'√©v√©nement confirm√©e !';
                        } else {
                            const errorData = await response.json();
                            this.errorMessage = errorData.detail || 'Erreur inscription √©v√©nement';
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur de connexion';
                    }
                },
                
                getConversationType(type) {
                    const types = {
                        direct: 'Direct',
                        group: 'Groupe',
                        class: 'Classe',
                        announcement: 'Annonce'
                    };
                    return types[type] || type;
                },
                
                getEventTypeClass(type) {
                    const classes = {
                        school: 'bg-blue-100 text-blue-800',
                        class: 'bg-green-100 text-green-800',
                        celebration: 'bg-purple-100 text-purple-800',
                        parent_meeting: 'bg-orange-100 text-orange-800',
                        activity: 'bg-yellow-100 text-yellow-800'
                    };
                    return classes[type] || 'bg-gray-100 text-gray-800';
                },
                
                getEventTypeText(type) {
                    const texts = {
                        school: '√âcole',
                        class: 'Classe', 
                        celebration: 'F√™te',
                        parent_meeting: 'R√©union',
                        activity: 'Activit√©',
                        general: 'G√©n√©ral'
                    };
                    return texts[type] || type;
                },
                
                formatEventDate(dateStr) {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('fr-BE', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                },
                
                formatTime(dateStr) {
                    return new Date(dateStr).toLocaleTimeString('fr-BE', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                
                async loadOtherUsers() {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch('/users/list', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.ok) {
                            this.otherUsers = await response.json();
                        }
                    } catch (error) {
                        console.error('Erreur utilisateurs:', error);
                    }
                },
                
                async createDirectMessage() {
                    if (!this.newDirectMessage.user_id || !this.newDirectMessage.content.trim()) return;
                    
                    this.isLoading = true;
                    
                    try {
                        const token = localStorage.getItem('token');
                        
                        // 1. Cr√©er ou obtenir conversation directe
                        const conversationResponse = await fetch('/conversations/direct', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` },
                            body: new FormData(Object.assign(document.createElement('form'), {
                                innerHTML: `<input name="other_user_id" value="${this.newDirectMessage.user_id}">`
                            }))
                        });
                        
                        if (conversationResponse.ok) {
                            const conversationData = await conversationResponse.json();
                            
                            // 2. Envoyer le message
                            const messageResponse = await fetch(`/conversations/${conversationData.conversation_id}/messages`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    content: this.newDirectMessage.content
                                })
                            });
                            
                            if (messageResponse.ok) {
                                this.showNewMessageForm = false;
                                this.newDirectMessage = { user_id: '', content: '' };
                                await this.loadConversations();
                                this.successMessage = 'Message envoy√© !';
                            }
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur envoi message';
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                async messageServiceOwner(service) {
                    // Message rapide au propri√©taire d'un service
                    const message = prompt(`Message pour ${service.user?.first_name || 'le propri√©taire'} du service "${service.title}":`);
                    if (!message?.trim()) return;
                    
                    try {
                        const token = localStorage.getItem('token');
                        
                        // Cr√©er conversation directe
                        const formData = new FormData();
                        formData.append('other_user_id', service.user_id);
                        
                        const conversationResponse = await fetch('/conversations/direct', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` },
                            body: formData
                        });
                        
                        if (conversationResponse.ok) {
                            const conversationData = await conversationResponse.json();
                            
                            // Envoyer message avec contexte du service
                            const contextMessage = `√Ä propos de votre service "${service.title}": ${message}`;
                            
                            const messageResponse = await fetch(`/conversations/${conversationData.conversation_id}/messages`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ content: contextMessage })
                            });
                            
                            if (messageResponse.ok) {
                                this.successMessage = 'Message envoy√© au propri√©taire du service !';
                                this.currentTab = 'messages';
                                await this.loadConversations();
                            }
                        }
                    } catch (error) {
                        this.errorMessage = 'Erreur envoi message';
                    }
                },
                
                logout() {
                    // Stop message polling
                    this.stopMessagePolling();
                    
                    localStorage.removeItem('token');
                    this.isAuthenticated = false;
                    this.user = null;
                    this.currentTab = 'dashboard';
                    this.selectedConversation = null;
                    this.conversationMessages = [];
                    this.successMessage = 'D√©connexion r√©ussie';
                }
            }
        }).mount('#app');
    </script>
</body>
</html>